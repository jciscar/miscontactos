<?php
session_start();
?>
<!DOCTYPE html>
<html lang="es">
<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Agentes comerciales</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

	<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js">"</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
	<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.css">
	<script src="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.js"></script>
	<script src="https://unpkg.com/bootstrap-table@1.19.1/dist/locale/bootstrap-table-es-ES.min.js"></script>

  	<script src="libgp01.js"></script>

  	<link rel="shortcut icon" href="logo.ico">

<style>
    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }

    @media (max-width: 992px) {
        #titulo { font-size: 18px };
    }  

    @media (min-width: 993px) {
        #aceptar:after  { content: '  Guardar';}
        #cancelar:after { content: '  Cancelar';}
    }

    @media (min-width: 993px) {
        #aceptar1:after     { content: '  Guardar';}
        #cancelar1:after { content: '  Cancelar';}
    }   

    .success {
            background: #92c5fc;
            font-weight: bold;
    }   

    .success1 {
            background: #92c5fc;
            font-weight: bold;
    }       

    .closed { display: none; }
    .opened { display: block; }

    .wrapper {
        overflow-y: hidden;
        overflow-x: hidden;
    }

    .dropdown-menu > li:hover > .submenu{ display: block; margin-left:2rem; } 


	/* The snackbar - position it at the bottom and in the middle of the screen */
	#snackbar {
	  visibility: hidden; /* Hidden by default. Visible on click */
	  min-width: 250px; /* Set a default minimum width */
	  margin-left: -125px; /* Divide value of min-width by 2 */
	  background-color: #333; /* Black background color */
	  color: #fff; /* White text color */
	  text-align: center; /* Centered text */
	  border-radius: 2px; /* Rounded borders */
	  padding: 16px; /* Padding */
	  position: fixed; /* Sit on top of the screen */
	  z-index: 1; /* Add a z-index if needed */
	  left: 50%; /* Center the snackbar */
	  bottom: 30px; /* 30px from the bottom */
	}

	/* Show the snackbar when clicking on a button (class added with JavaScript) */
	#snackbar.show {
	  visibility: visible; /* Show the snackbar */
	  /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
	  However, delay the fade out process for 2.5 seconds */
	  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
	  animation: fadein 0.5s, fadeout 0.5s 2.5s;
	}

	/* Animations to fade the snackbar in and out */
	@-webkit-keyframes fadein {
	  from {bottom: 0; opacity: 0;}
	  to {bottom: 30px; opacity: 1;}
	}

	@keyframes fadein {
	  from {bottom: 0; opacity: 0;}
	  to {bottom: 30px; opacity: 1;}
	}

	@-webkit-keyframes fadeout {
	  from {bottom: 30px; opacity: 1;}
	  to {bottom: 0; opacity: 0;}
	}

	@keyframes fadeout {
	  from {bottom: 30px; opacity: 1;}
	  to {bottom: 0; opacity: 0;}
	}      

</style>

  </head>
  <body class="bg-light" onunload="descargar()">

  <script>

  	// gestión ventanas. Es la función que se ejecutar en onunload de body
  	function descargar() { despuesDeCerrarVentana('nExtAgentes', 'agentes'); }

    document.addEventListener("DOMContentLoaded", function(event) {
    	compProcedencia();
    	// gestión ventanas
    	despuesDeAbrirVentana('nExtAgentes', 'agentes');

		$('[data-toggle="tooltip"]').tooltip({ trigger: "hover" });

	    permisosVentana('agentes');
	    
		cambiarAltoTabla();

		return false;
    });

	$(document).ready(function(e) {
		barraPaginacion('#tabAgentes');
		if (window.nExtAgentes != 0) { msjDblClic(); }	
		return false;	
	});	

	window.addEventListener("resize", function(event) {
		cambiarAltoTabla();
		barraPaginacion('#tabAgentes');
		return false;
	});

	//funciona en chrome pero no en firefox
	window.addEventListener("load", function(event) {
		//cambiarAltoTabla();
		return false;
	});	

	document.addEventListener("backbutton", function(){}, false);

	function eliminarAgente(){	
		let formDataE = new FormData();
		formDataE.append("nform", 'agentes');
		formDataE.append("codnum", window.idTabAgentes);
		formDataE.append("opcionlistado", 3);
		async function compAntesDeEliminar() {
			const compResponseE 	= await fetch('php/comprobar_antes_de_editar_o_eliminar.php', {
	      		method: 'POST',
	      		body: 	formDataE
	    	});
			const dataE 			= await compResponseE.json();
			return dataE;
		}
		compAntesDeEliminar().then((dataE) => {
			//alert(dataE);
			if (dataE == '[object Object]') {
				let myModalE 		= new bootstrap.Modal(document.getElementById('formEliminarAgente'));
				myModalE.show();
				codE.defaultValue 	= dataE.codE;
				nomE.defaultValue 	= dataE.nomE;
			} else {
				document.getElementById('msjAgentes').innerText = dataE;
				let myModal 		= new bootstrap.Modal(document.getElementById('dialogoAgentes'));
				myModal.show();
			};				
		}).catch(error => {
			alert(error.message);
		});
        return false;
	}
 
    function imprimir () {
        localStorage.setItem("tipoDocImp", 22);
        var windowObjectImprimir = window.open("imprimir.html", '_blank');
        windowObjectImprimir.focus();		
    } 	

    function exportar () {
        localStorage.setItem("tipoDocExp", 22);
        var windowObjectExportar = window.open("exportar.html", '_blank');
        windowObjectExportar.focus();		
    }

</script>

<div class="wrapper">


<div class="container-fluid sticky-top bg-light" id="contenedor">
  	<div class="row justify-content-between align-content-center gx-0 gy-2" id="fila">

	  	<div class="col-auto d-none d-md-block mt-1 mb-1">
	  		<button class="btn btn-success btn-sm" id="agen1" title="Ver agente" data-toggle="tooltip" onClick="regTabla('modalAgente', 'opcionAgente', 4)"><i class="bi bi-person-fill" style="font-size: 1.4rem; color: currentColor;"></i></button>
			<div class="btn-group" role="group">
				<button class="btn btn-success btn-sm" id="agen2" title="Nuevo agente" data-toggle="tooltip" onClick="regTabla('modalAgente', 'opcionAgente', 1)"><i class="bi bi-person-plus-fill" style="font-size: 1.4rem; color: currentColor;"></i></button>
				<button class="btn btn-success btn-sm" id="agen3" title="Editar agente" data-toggle="tooltip" onClick="regTabla('modalAgente', 'opcionAgente', 2)"><i class="bi bi-person-lines-fill" style="font-size: 1.4rem; color: currentColor;"></i></button>
				<button class="btn btn-success btn-sm" id="agen4" title="Eliminar agente" data-toggle="tooltip" onClick="eliminarAgente()"><i class="bi bi-person-dash-fill" style="font-size: 1.4rem; color: currentColor;"></i></button>


				
				<!-- 
				<button class="btn btn-success btn-sm dropdown-toggle" type="button" id="MenuEscritorio" data-bs-toggle="dropdown" aria-expanded="false" data-toggle="tooltip" title="Más opciones">
				<i class="bi bi-list" style="font-size: 1.4rem; color: currentColor;"></i>
				</button>
			  	<ul class="dropdown-menu" aria-labelledby="MenuEscritorio">
			  		<li><a class="dropdown-item" onClick="imprimir()" href="#"><i class="bi bi-printer-fill" style="font-size: 1rem; color: currentColor;"></i> Imprimir</a></li>
					<li><a class="dropdown-item" onClick="exportar()" href="#"><i class="bi bi-file-earmark-arrow-down-fill" style="font-size: 1rem; color: currentColor;"></i> Exportar</a></li>
			  	</ul>
			  	 -->
			</div>

			<button class="btn btn-success btn-sm" id="gesd" title="Gestión documental" data-toggle="tooltip" onClick="gesDoc(22)"><i class="bi bi-folder-symlink" style="font-size: 1.4rem; color: currentColor;"></i></button>			


			<div class="btn-group" role="group">

				<button class="btn btn-success btn-sm d-none d-md-block" id="agen5" title="Imprimir tabla" data-toggle="tooltip" onClick="imprimirTabla('Agentes', tabAgentes)"><i class="bi bi-printer" style="font-size: 1.4rem; color: currentColor;"></i></button>
				<button class="btn btn-success btn-sm dropdown-toggle d-none d-md-block" type="button" id="agen6" data-bs-toggle="dropdown" aria-expanded="false" data-toggle="tooltip" title="Exportar tabla">
				<i class="bi-file-earmark-arrow-down" style="font-size: 1.4rem; color: currentColor;"></i>
				</button>
			  	<ul class="dropdown-menu" aria-labelledby="agen6">
			  		<li><h5 class="dropdown-header">Exportar a:</h5></li>
					<li><a class="dropdown-item" onClick="exportarTabla('excel','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">MS-Excel</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('csv','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">CSV</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('txt','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">TXT</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('json','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">JSON</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('sql','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">SQL</a></li>
			  	</ul>

				<button class="btn btn-success btn-sm d-none d-md-block" id="columnasAgentes" title="Mostrar columnas" data-toggle="tooltip" onClick="mostrarColumnas('modalColumnasTablasAgentes', 0)"><i class="bi-layout-three-columns" style="font-size: 1.4rem; color: currentColor;"></i></button>
			</div>


			

		</div>

		<div class="col-auto align-self-center d-none d-lg-block mt-1 mb-1">
			<a class="navbar-brand" style="font-weight:bold;" id="titulo">Agentes comerciales</a>
		</div>		

		<div class="col-auto d-sm-block d-md-none mt-1 mb-1">
			<button class="btn btn-success dropdown-toggle" type="button" id="MenuMovil" data-bs-toggle="dropdown" aria-expanded="false">
			<i class="bi bi-list" style="font-size: 1rem; color: currentColor;"></i> </button>
		  	<ul class="dropdown-menu" aria-labelledby="MenuMovil">

		  		<li><a class="dropdown-item" id="agen1b" onClick="regTabla('modalAgente', 'opcionAgente', 4)" href="#"><i class="bi bi-person-fill" style="font-size: 1rem; color: currentColor;"></i> Ver agente</a></li>
				<li><a class="dropdown-item" id="agen2b" onClick="regTabla('modalAgente', 'opcionAgente', 1)" href="#"><i class="bi bi-person-plus-fill" style="font-size: 1rem; color: currentColor;"></i> Nuevo agente</a></li>
				<li><a class="dropdown-item" id="agen3b" onClick="regTabla('modalAgente', 'opcionAgente', 2)" href="#"><i class="bi bi-person-lines-fill" style="font-size: 1rem; color: currentColor;"></i> Editar agente</a></li>
				<li><a class=" dropdown-item" id="agen4b" onClick="eliminarAgente()" href="#"><i class="bi bi-person-dash-fill" style="font-size: 1rem; color: currentColor;"></i> Eliminar agente</a></li>
				<li><a class=" dropdown-item" id="gesdb" onClick="gesDoc(22)" href="#"><i class="bi bi-person-dash-fill" style="font-size: 1rem; color: currentColor;"></i> Gestión documental</a></li>								

				
				<!-- 
				<li><hr class="dropdown-divider"></li>

			  	<li><a class="dropdown-item" onClick="imprimir()" href="#"><i class="bi bi-printer-fill" style="font-size: 1rem; color: currentColor;"></i> Imprimir</a></li>
				<li><a class="dropdown-item" onClick="exportar()" href="#"><i class="bi bi-file-earmark-arrow-down-fill" style="font-size: 1rem; color: currentColor;"></i> Exportar</a></li>
				 -->
				
				<li><hr class="dropdown-divider"></li>

				<li class="dropend"><a class="dropdown-item dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" href="#" id="opcionesTablaSubmenu"><i class="bi bi-table" style="font-size: 1rem; color: currentColor;"></i> Tabla </a>
				  <ul class="submenu dropdown-menu" aria-labelledby="opcionesTablaSubmenu" id="opcion1">

		  			<li><a class="dropdown-item" onClick="valorTarjeta('tabAgentes')" href="#"><i class="bi bi-card-list" style="font-size: 1rem; color: currentColor;"></i> Tarjeta/Tabla</a></li>

				  	<li><a class="dropdown-item" href="#" onClick="mostrarColumnas('modalColumnasTablasAgentes', 0)"><i class="bi bi-layout-three-columns" style="font-size: 1rem; color: currentColor;"></i> Mostrar columnas</a></li>

				  	<li><a class="dropdown-item" id="agen5b" href="#" onClick="imprimirTabla('Agentes', tabAgentes)"><i class="bi bi-printer" style="font-size: 1rem; color: currentColor;"></i> Imprimir</a></li>

				  	<li class="dropstart"><a class="dropdown-item dropdown-toggle" id="agen6b" type="button" data-bs-toggle="dropdown" aria-expanded="false" href="#"><i class="bi-file-earmark-arrow-down" style="font-size: 1rem; color: currentColor;"></i> Exportar a </a>
				  	 	<ul class="submenu submenu1 dropdown-menu" aria-labelledby="agen6b">
							<li><a class="dropdown-item" onClick="exportarTabla('excel','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">MS-Excel</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('csv','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">CSV</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('txt','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">TXT</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('json','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">JSON</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('sql','Agentes','Tabla de Agentes',100, 'tabAgentes')" href="#">SQL</a></li>
				  	 	</ul>
				  	</li>
				 </ul>
			</li>
		</ul>
	</div>	

		<div class="col-auto align-self-center mt-1 mb-1">
			<div class="btn-group" role="group">
		  		<input type="search" id="buscar" class="form-control" placeholder="Buscar" onchange="buscarAhora('tabAgentes','buscar')" title="Buscar en la tabla" data-toggle="tooltip">
		  	</div>
		</div>

		<div class="col-auto align-self-center mt-1 mb-1">
			<div class="btn-group" role="group">
				<div class="form-check form-switch btn-sm d-none d-md-block">
					<input class="form-check-input" type="checkbox" id="vistaTarjeta" title="Vista de tarjeta" data-toggle="tooltip" onchange="valorTarjeta('tabAgentes')">
					<label class="form-check-label" for="vistaTarjeta"></label>			
				</div>		
			</div>
		</div>

		<div class="col-auto align-self-center mt-1 mb-1">
		  	<div class="btn-group" role="group">
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" title="Cerrar" onclick="cerrarVentana('nExtAgentes')" data-toggle="tooltip"></button>
			</div>
		</div>
	</div>
</div>

<script>

    opcionesTablaSubmenu.addEventListener('click',  (e) => { 
        e.stopPropagation();
    });

    opcionesExportarSubmenu.addEventListener('click',   (e) => { 
        e.stopPropagation();
    });

</script>

<div id="snackbar">Doble clic para seleccionar el agente</div>

<div class="container-fluid">
    <table class="table table-striped table-hover table-responsive" data-page-number="1" id="tabAgentes" data-url="./php/datosTabla.php?vista=agentes" data-method="post" data-locale="es-sp" data-toggle="table" data-id-field="can" data-undefined-text=""

    data-unique-id="can"

    data-search="true"
    data-show-search-button="false"
    data-search-selector="#buscar"
    data-search-highlight="true"
    data-search-on-enter-key="false"

    data-side-pagination="client"
    data-pagination="true"
    data-page-size="100"
    data-show-pagination-switch="false"
    data-show-extended-pagination="false"
    data-pagination-parts="['pageList']"

    data-id-table="tabAgentes"

    data-click-to-select="true"
    data-single-select="true"

    data-sort-name="cod"
    data-sort-order="asc"

    data-virtual-scroll="false"

  	data-icons-prefix="bi"
  	data-icons="icons"    

    data-auto-refresh="true"
    data-auto-refresh-interval="60"
    data-show-refresh="false"
    data-show-auto-refresh="false"
    data-auto-refresh-silent="true"   

    data-export-data-type="all"

    data-detail-view="true"
    data-detail-formatter="detailFormatter"
    data-row-style="rowStyle"

    data-cache="false"

    >

    
    <thead class="bg-dark text-light">
        <tr>
			<th data-field="can" data-sortable="false" data-visible="false" data-searchable="false" data-switchable="false" data-print-ignore="true" data-force-hide="true" data-card-visible="false"></th>
			<th data-field="cod" data-sortable="true" data-click-to-select="true" data-switchable="false">Código</th>
			<th data-field="nom" data-sortable="true" data-click-to-select="true">Nombre</th>
			<th data-field="nif" data-sortable="true" data-click-to-select="true">NIF</th>
			<th data-field="zoc" data-sortable="true" data-click-to-select="true" data-visible="false">Zona</th>
			<th data-field="zod" data-sortable="true" data-click-to-select="true" data-visible="false">Descripción zona</th>
			<th data-field="dom" data-sortable="true" data-click-to-select="true" data-visible="false">Dirección</th>
			<th data-field="cpo" data-sortable="true" data-click-to-select="true" data-visible="false">C. P.</th>
			<th data-field="pob" data-sortable="true" data-click-to-select="true">Población</th>
			<th data-field="pro" data-sortable="true" data-click-to-select="true" data-visible="false">Provincia</th>
			<th data-field="pai" data-sortable="true" data-click-to-select="true" data-visible="false">País</th>
			<th data-field="per" data-sortable="true" data-click-to-select="true" data-visible="false">Nombre contacto</th>
			<th data-field="te1" data-sortable="true" data-click-to-select="true" data-visible="false">Teléfono 1</th>
			<th data-field="te2" data-sortable="true" data-click-to-select="true" data-visible="false">Teléfono 2</th>
			<th data-field="fax" data-sortable="true" data-click-to-select="true" data-visible="false">Fax</th>
			<th data-field="cor" data-sortable="true" data-click-to-select="true" data-visible="false">E-mail</th>
			<th data-field="fpc" data-sortable="true" data-click-to-select="true" data-visible="false">Forma pago</th>
			<th data-field="fpd" data-sortable="true" data-click-to-select="true" data-visible="false">Descripción forma pago</th>
			<th data-field="dic" data-sortable="true" data-click-to-select="true" data-visible="false">Divisa</th>
			<th data-field="din" data-sortable="true" data-click-to-select="true" data-visible="false">Nombre divisa</th>
			<th data-field="sub" data-sortable="true" data-click-to-select="true" data-visible="false">Subcuenta</th>
			<th data-field="alt" data-sortable="true" data-click-to-select="true" data-visible="false">Alta</th>
        </tr>
    </thead>
    <tbody>
    </tbody>

    </table>

</div>

</div>



<!-- Comienzo modal form agente -->
<div class="modal fade" id="modalAgente" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  	<div class="modal-dialog modal-xl">
      	<div class="modal-content">
	        <!-- Modal Header -->
	      	<div class="modal-header bg-dark bg-gradient sticky-top">
	        	<div class="col-6">
	            	<a class="navbar-brand text-warning" id="exampleModalLabel">Agente</a>
	          	</div>
				<div class="col-auto" style="text-align:right;">
					<form id="formAgente">
					<input type="hidden" name="can"  id="can" value=0>						
					<button type="submit" class="btn btn-success text-white mr-3" id="aceptar" value="Aceptar" title="Guardar cambios" data-toggle="tooltip"><i class="bi bi-check-circle" style="font-size: 1rem; color: white;" ></i> </button>
					<button type="reset" class="btn btn-warning btn-sm" id="cancelar" value="Cancelar" title="Cancelar cambios" data-toggle="tooltip"><i class="bi bi-x-circle" style="font-size: 1rem;"></i> </button>	
				</div>
				<div class="col-1" style="text-align:right;">
			        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" data-toggle="tooltip" title="Cerrar ventana">
			        </button>
		        </div>
			</div>

          	<!-- Modal body -->
          	<div class="modal-body bg-primary bg-opacity-25">

				<div class="container-fluid">

					<div id="myTextData"></div>

					<div class="row justify-content-between gx-2 gy-2 mb-3">
						<div class="col-lg-2 col-auto form-floating">
							<input type="text" name="cod" id="cod" value="" placeholder="Código" maxlength=15 size=15 required class="form-control" title="Código del agente" data-toggle="tooltip">
							<label for="cod">Código</label>
						</div>
						<div class="col-lg-8 col-auto form-floating">
							<input type="text" name="nom" id="nom" value="" placeholder="Nombre" maxlength=60 size=60 required class="form-control w-100" title="Nombre del agente" data-toggle="tooltip">
							<label for="nom">Nombre</label>
						</div>
						<div class="col-lg-2 col-auto form-floating">
							<input type="date" name="alt" id="alt" value="" title="Fecha de alta del agente" data-toggle="tooltip" required class="form-control">
							<label for="alt">Alta</label>
						</div>
					</div>

					<div class="row gx-3 gy-2 mb-3">
						<div class="col-auto">
							<input type="text" name="nif" id="nif" value="" placeholder="NIF" maxlength="35" class="form-control" size=35 title="NIF del agente" data-toggle="tooltip">
						</div>

						<div class="col-auto">
							<div class="row align-items-end gx-2 gy-1">
								<div class="col-auto">
									<label for="zoc" class="col-form-label">Zona</label>
								</div>
								<div class="col-auto">
									<div class="input-group">
										<input type="text" name="zoc" id="zoc" size=5 maxlength="5" readonly class="form-control" title="Código de la zona del agente" data-toggle="tooltip">
										<div class="input-group-append">
											<button type="button" class="btn btn-outline-secondary" id="abrirZonas" title="Abrir el fichero de zonas" data-toggle="tooltip"><i class="bi bi-search" style="font-size: 1rem; color: currentColor;"></i></button>
										</div>
									</div>
								</div>
								<div class="col-auto">
									<input type="text" id="zod" size=40 maxlength="40" readonly class="form-control" title="Nombre de la zona del agente" data-toggle="tooltip">
								</div>
							</div>
						</div>

					</div>

			        <div class="accordion accordion-flush mb-3" id="accordionFlushExample">
			          <div class="accordion-item">
			            <h2 class="accordion-header" id="flush-headingOne">
			              <button class="accordion-button collapsed bg-success bg-opacity-10" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
			                <i class="p-1 bi bi-shop-window" style="font-size: 1rem; color: currentColor;"></i>  Dirección fiscal
			              </button>
			            </h2>
			            <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
			                <div class="accordion-body bg-primary bg-opacity-25">

								<div class="row align-items-end gx-3 gy-3 mb-3">
									<div class="col-auto form-floating">
										<input type="text" name="dom" id="dom" size=50 placeholder="Dirección" maxlength="50" class="form-control" title="Dirección" data-toggle="tooltip">
										<label for="dom">Dirección</label>
									</div>

									<div class="col-auto form-floating">
										<input type="text" name="cpo" id="cpo" size=5 placeholder="C. P." maxlength="5" class="form-control" title="Código postal" data-toggle="tooltip">
										<label for="cpo">C. P.</label>
									</div>

									<div class="col-auto form-floating">
										<input type="text" name="pob" id="pob" size=30 placeholder="Población" maxlength="30" class="form-control" title="Población" data-toggle="tooltip">
										<label for="pob">Población</label>
									</div>

									<div class="col-auto form-floating">
										<input type="text" name="pro" id="pro" size=30 placeholder="Provincia" maxlength="30" class="form-control" title="Provincia" data-toggle="tooltip">
										<label for="pro">Provincia</label>
									</div>

									<div class="col-auto form-floating">
										<input type="text" name="pai" id="pai" size=30 placeholder="País" maxlength="30" class="form-control" title="País" data-toggle="tooltip">
										<label for="pai">País</label>
									</div>
								</div>

								<div class="row align-items-end gx-3 gy-3 mb-3">
									<div class="col-auto">
										<div class="input-group">
											<input type="text" name="te1" id="te1" placeholder="Teléfono 1" maxlength="25" size=25 class="form-control" title="Teléfono 1" data-toggle="tooltip">
											<div class="input-group-append">
												<div class="btn-group">
			  										<button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton1D" data-bs-toggle="dropdown" aria-expanded="false">
			  										</button>
			  										<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1D">
													    <li><a class="dropdown-item" href="#" id="tel1LlamarD" onclick="hiperenlace(te1.value, 1)"><i class="bi bi-telephone" style="font-size: 1rem; color: currentColor;"></i> Llamar</a></li>
													    <li onclick="hiperenlace(te1.value, 3)"><a class="dropdown-item" href="#" id="tel1What
													    	D"><i class="bi bi-whatsapp" style="font-size: 1rem; color: currentColor;"></i> WhatsApp</a></li>
													    <li onclick="hiperenlace(te1.value, 2)"><a class="dropdown-item" href="#" id="tel1smsD"><i class="bi bi-chat-left-text" style="font-size: 1rem; color: currentColor;"></i> SMS</a></li>
													</ul>
			  									</div>
			  								</div>
			  							</div>
									</div>

									<div class="col-auto">
										<div class="input-group">
											<input type="text" name="te2" id="te2" placeholder="Teléfono 2" maxlength="25" size=25 class="form-control" title="Teléfono 2" data-toggle="tooltip">
											<div class="input-group-append">
												<div class="btn-group">
			  										<button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton2D" data-bs-toggle="dropdown" aria-expanded="false">
			  										</button>
			  										<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton2D">
													    <li><a class="dropdown-item" href="#" id="tel2LlamarD" onclick="hiperenlace(te2.value, 1)"><i class="bi bi-telephone" style="font-size: 1rem; color: currentColor;"></i> Llamar</a></li>
													    <li><a class="dropdown-item" href="#" id="tel2WhatD" onclick="hiperenlace(te2.value, 3)"><i class="bi bi-whatsapp" style="font-size: 1rem; color: currentColor;"></i> WhatsApp</a></li>
													    <li><a class="dropdown-item" href="#" id="tel2smsD" onclick="hiperenlace(te2.value, 2)"><i class="bi bi-chat-left-text" style="font-size: 1rem; color: currentColor;"></i> SMS</a></li>
													</ul>
			  									</div>
			  								</div>
			  							</div>
									</div>

									<div class="col-auto">
										<input type="text" name="fax" id="fax" size=25 placeholder="Fax" maxlength="25" class="form-control" title="Fax" data-toggle="tooltip">
									</div>

								</div>

								<div class="row align-items-end gx-3 gy-3 mb-3">

									<div class="col-auto">
										<div class="input-group">
											<input type="email" name="cor" id="cor" placeholder="Correo electrónico" maxlength="50" size=50 class="form-control" title="Correo electrónico" data-toggle="tooltip">
											<div class="input-group-append">
											<button type="button" class="btn btn-outline-secondary ml-auto" id="abrirD" title="Enviar un mensaje" onclick="hiperenlace(cor.value, 5)"><i class="bi bi-at" style="font-size: 1rem; color: currentColor;"></i></button>
											</div>
										</div>
									</div>

									<div class="col-auto">
										<input type="text" name="per" id="per" placeholder="Persona de contacto" size=40 maxlength="40" class="form-control" title="Persona de contacto" data-toggle="tooltip">
									</div>

								</div>


							 </div>
						</div>
					</div>

					<div class="accordion-item">
						<h2 class="accordion-header" id="flush-headingTwo">
							<button class="accordion-button collapsed bg-success bg-opacity-10" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
					    		<i class="p-1 bi bi-credit-card" style="font-size: 1rem; color: currentColor;"></i>  Datos de pago
					  		</button>
						</h2>
						<div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
						<div class="accordion-body bg-primary bg-opacity-25">

		    				<div class="row g-1 mb-3">
								<div class="col-auto form-floating">
									<input type="text" name="ent" id="ent" maxlength=4 size=4 required class="form-control" title="Entidad" data-toggle="tooltip">
									<label for="ent">Entidad</label>
					          	</div>
					          	<div class="col-auto form-floating">
					              	<input type="text" name="ofi" id="ofi" maxlength=4 size=4 required class="form-control" title="Oficina" data-toggle="tooltip">
					              	<label for="ofi">Oficina</label>
					            </div>
					            <div class="col-auto form-floating">
					              	<input type="text" name="ndc" id="ndc" maxlength=2 size=2 required class="form-control" title="Dígitos de control" data-toggle="tooltip">
					              	<label for="ndc">D. C.</label>
					            </div>
					            <div class="col-auto form-floating">
					              	<input type="text" name="cue" id="cue" maxlength=10 size=10 required class="form-control" title="Número de cuenta" data-toggle="tooltip">
					              	<label for="cue">Nº de cuenta</label>
					            </div>
					        	
					        </div>
					        <div class="row g-1 mb-3">
					            <div class="col-auto form-floating">
					                <input type="text" name="iba" id="iba" maxlength="4" size=4 placeholder="IBAN" title="IBAN" class="form-control" style="text-align:center" data-toggle="tooltip">
					                <label for="iban">IBAN</label>
					            </div>
					            <div class="col-auto form-floating">
					              	<input type="text" name="bic" id="bic" maxlength="8" size=8 placeholder="BIC" title="BIC" class="form-control" style="text-align:center" data-toggle="tooltip">
					              	<label for="bic">BIC</label>
					            </div>
					            <div class="col-auto form-floating">
									<input type="text" name="nba" id="nba" size=40 placeholder="Banco" readonly class="form-control" title="Nombre del banco" data-toggle="tooltip">
									<label for="nombreBanco">Banco</label>
								</div>
					        </div>

			            </div>
			        </div>
			    </div>     	

				<div class="accordion-item">
				<h2 class="accordion-header" id="flush-headingFour">
				  <button class="accordion-button collapsed bg-success bg-opacity-10" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseFour" aria-expanded="false" aria-controls="flush-collapseFour">
				    <i class="p-1 bi bi-file-earmark-post-fill" style="font-size: 1rem; color: currentColor;"></i>  Liquidaciones
				  </button>
				</h2>
				<div id="flush-collapseFour" class="accordion-collapse collapse" aria-labelledby="flush-headingFour" data-bs-parent="#accordionFlushExample">
				    <div class="accordion-body bg-primary bg-opacity-25">

						<div class="row align-items-end gx-3 gy-3 mb-3">
		    				<div class="col-auto">
			    				<label for="dp1">Día de pago 1</label>
			    				<input type="number" name="dp1" id="dp1" required value=0 min=0 max=31 size=2 style="text-align:right;" class="form-control" title="Día de pago 1" data-toggle="tooltip">
		    				</div>
		    				<div class="col-auto">
			    				<label for="dp2">Día de pago 2</label>
			    				<input type="number" name="dp2" id="dp2" required value=0 min=0 max=31 size=2 style="text-align:right;" class="form-control" title="Día de pago 2" data-toggle="tooltip">
		    				</div>
		    				<div class="col-auto">
			    				<label for="dp3">Día de pago 3</label>
			    				<input type="number" name="dp3" id="dp3" required value=0 min=0 max=31 size=2 style="text-align:right;" class="form-control" title="Día de pago 3" data-toggle="tooltip">
		    				</div>
		    				<div class="col-auto form-floating">
		                        <select name="mnp" id="mnp" class="form-select" title="Mes no pago" data-toggle="tooltip">
		                            <option value=0>Ninguno</option>
		                            <option value=1>Enero</option>
		                            <option value=2>Febrero</option>
		                            <option value=3>Marzo</option>
		                            <option value=4>Abril</option>
		                            <option value=5>Mayo</option>
		                            <option value=6>Junio</option>
		                            <option value=7>Julio</option>
		                            <option value=8>Agosto</option>
		                            <option value=9>Septiembre</option>
		                            <option value=10>Octubre</option>
		                            <option value=11>Noviembre</option>
		                            <option value=12>Diciembre</option>
		                        </select>
		                        <label for="mnp">Mes no pago</label>	    					
		    				</div>
			    		</div>

						<div class="row align-items-end gx-3">

		    				<div class="col-auto">
				    			<div class="row align-items-end gx-2 gy-1 mb-3">
									<div class="col-auto">
										<label for="dic">Divisa</label>
										<div class="input-group">
											<input type="text" name="dic" id="dic" size=3 readonly class="form-control" title="Código de divisa" data-toggle="tooltip">
											<div class="input-group-append">
												<button type="button" class="btn btn-outline-secondary" id="abrirDivisas" title="Abrir el fichero de divisas" data-toggle="tooltip"><i class="bi bi-search" style="font-size: 1rem; color: currentColor;"></i></button>
											</div>
										</div>							
									</div>
									<div class="col-auto">
										<input type="text" id="din" size=30 readonly class="form-control" title="Nombre de la divisa" data-toggle="tooltip">
									</div>
								</div>
							</div>


							<div class="col-auto">
								<div class="row align-items-end gx-2 gy-1 mb-3">
									<div class="col-auto">
										<label for="fpc">Forma de pago</label>
										<div class="input-group">
											<input type="text" name="fpc" id="fpc" size=5 readonly class="form-control" title="Código de la forma de pago" data-toggle="tooltip">
											<div class="input-group-append">
												<button type="button" class="btn btn-outline-secondary" id="abrirFormasPago" title="Abrir el fichero de formas de pago" data-toggle="tooltip"><i class="bi bi-search" style="font-size: 1rem; color: currentColor;"></i></button>
											</div>
										</div>
									</div>
									<div class="col-auto">
										<input type="text" id="fpd" size=40 readonly class="form-control" title="Nombre de la forma de pago" data-toggle="tooltip">
									</div>
								</div>
							</div>		
							<div class="col-auto form-floating">
								<input type="text" name="sub" id="sub" placeholder="Subcuenta" maxlength="12" size=12 class="form-control" title="Subcuenta contable" data-toggle="tooltip">
								<label for="sub">Subcuenta</label>
							</div>

							<div class="col-auto form-floating">
								<input type="text" name="irp" id="irp" required size=8 style="text-align:right; width:auto;" class="form-control" title="Retención IRPF" data-toggle="tooltip">
								<label for="irp">Retención IRPF</label>
							</div>

						</div>

				    		</div>
						</div>
					</div>
				</div>

				<div>
					<textarea name="not" id="not" placeholder="Notas" maxlength="120" size=120 class="form-control mb-3" title="Notas" data-toggle="tooltip"></textarea>
				</div>

			</div>

			</form>
			</div>

		</div>
	</div>
</div>



<script>

	ent.addEventListener('blur', (event) => {  ent.value = cadenaCeros(ent.value,  4);  });
	ofi.addEventListener('blur', (event) => {  ofi.value = cadenaCeros(ofi.value,  4);  });
	ndc.addEventListener('blur', (event) => {  ndc.value = cadenaCeros(ndc.value,  2);  });
	cue.addEventListener('blur', (event) => {  cue.value = cadenaCeros(cue.value, 10);  });	

	modalAgente.addEventListener('show.bs.modal', function (e) {	

		if (window.opcionAgente === 1) {

        	cod.focus();
			fpc.defaultValue	= 	localStorage.getItem('codFPpredProve');
			fpd.defaultValue	= 	localStorage.getItem('desFPpredProve');
			var date 			= 	new Date();
			var currentDate 	= 	date.toISOString().slice(0,10);
			alt.defaultValue	= 	currentDate;
			cod.defaultValue	=	'';
			nom.defaultValue	=	'';
			nif.defaultValue	=   '';

			zoc.defaultValue	=   localStorage.getItem('codZonaPred');
			zod.defaultValue	=   localStorage.getItem('desZonaPred');

			dom.defaultValue	=   '';
			cpo.defaultValue	=   '';
			pob.defaultValue	=   '';
			pro.defaultValue	=   '';
			pai.defaultValue	=   '';
			te1.defaultValue	=   '';
			te2.defaultValue	=   '';
			fax.defaultValue	=   '';
			cor.defaultValue	=   '';
			per.defaultValue	=   '';
			ent.defaultValue	= 	'0000';
			ofi.defaultValue	= 	'0000';
			ndc.defaultValue	= 	'00';
			cue.defaultValue	= 	'0000000000';
			iba.defaultValue	=   '';
			bic.defaultValue	=   '';
			nba.defaultValue	=   '';
			dp1.defaultValue	=	localStorage.getItem('dp1PD');
			dp2.defaultValue	=	localStorage.getItem('dp2PD');
			dp3.defaultValue	=	localStorage.getItem('dp3PD');
			seleccionarCombo('mnp', localStorage.getItem('mnpPD'));
			dic.defaultValue	=	localStorage.getItem('codDivPred');
			din.defaultValue	=	localStorage.getItem('nomDivPred');
			sub.defaultValue	=   '';
			irp.defaultValue 	=	'0,00 %';
			not.defaultValue	=   '';

			cod.readOnly	=	false;
			alt.readOnly	= 	false;
			nom.readOnly	=	false;
			nif.readOnly	=   false;
			dom.readOnly	=   false;
			cpo.readOnly	=   false;
			pob.readOnly	=   false;
			pro.readOnly	=   false;
			pai.readOnly	=   false;
			te1.readOnly	=   false;
			te2.readOnly	=   false;
			fax.readOnly	=   false;
			cor.readOnly	=   false;
			per.readOnly	=   false;
			ent.readOnly	=   false;
			ofi.readOnly	=   false;
			ndc.readOnly	=   false;
			cue.readOnly	=   false;
			iba.readOnly	=   false;
			bic.readOnly	=   false;
			dp1.readOnly	=   false;
			dp2.readOnly	=   false;
			dp3.readOnly	=   false;	
			mnp.disabled	= 	false;
			sub.readOnly	=   false;
			irp.readOnly	=	false;
			not.readOnly	=   false;

			aceptar.hidden	= 	false;
      		cancelar.hidden = 	false;		

		}

		if (window.opcionAgente === 2 || window.opcionAgente === 4) {

			let queries2 = "select a.`COD_AGENTE_N` AS `can`, a.`COD_AGENTE` AS `cod`, a.`NOMBRE` AS `nom`, a.`CIF` AS `nif`, DATE_FORMAT(`fecha_antiguedad`,'%Y-%m-%d') AS `alt`, a.`ZONA` AS `zoc`, d.`DESCRIPCION` AS `zod`, a.`DOMICILIO` AS `dom`, a.`COD_POSTAL` AS `cpo`, a.`POBLACION` AS `pob`, a.`PROVINCIA` AS `pro`, a.`PAIS` AS `pai`, a.`PERSONA_CONTACTO` AS `per`, a.`TELEFONO_1` AS `te1`, a.`TELEFONO_2` AS `te2`, a.`FAX` AS `fax`, a.`CE` AS `cor`, a.`DIVISA` AS `dic`, b.`NOMBRE` AS `din`, a.`FORMA_DE_PAGO` AS `fpc`, c.`DESCRIPCION` AS `fpd`, a.`DIA_DE_PAGO_1` AS `dp1`, a.`DIA_DE_PAGO_2` AS `dp2`, a.`DIA_DE_PAGO_3` AS `dp3`, a.`MES_NO_PAGO` AS `mnp`, a.`SUBCUENTA` AS `sub`, round(a.`RETENCION` * 100, 2) AS `irp`, a.`OBSERVACIONES` AS `not`, LPAD(a.`N_ENTIDAD`, 4, 0) AS `ent`, LPAD(a.`N_OFICINA`, 4, 0) AS `ofi`, LPAD(a.`N_DC`, 2, 0) AS `ndc`, LPAD(CAST(a.`N_CUENTA` AS DECIMAL(10,0)), 10, 0) AS `cue`, a.`IBAN` AS `iba`, a.`BIC` AS `bic` from `agentes` a JOIN `divisas` b ON a.`DIVISA` = b.`COD_DIVISA` JOIN `forma_de_pago` c ON a.`FORMA_DE_PAGO` = c.`COD` LEFT JOIN `zonas` d ON a.`ZONA` = d.`COD` where a.`COD_AGENTE_N`=" + window.idTabAgentes + ";";

			let formData2 = new FormData();
			formData2.append('queries', queries2);
			formData2.append('esBDempresas', 0);
			async function datosDevueltos2() {
				const response2 = await fetch('php/multiselect.php', {
		      		method: 'POST',
		      		body: formData2
		    	});
				const data = await response2.json();
				return data;
			};
			datosDevueltos2().then((data) => {
				can.defaultValue	=	data[0].can;
				fpc.defaultValue	= 	data[0].fpc;
				fpd.defaultValue	= 	data[0].fpd;

				alt.defaultValue	= 	data[0].alt;
				cod.defaultValue	=	data[0].cod;
				nom.defaultValue	=	data[0].nom;
				nif.defaultValue	=   data[0].nif || '';

				zoc.defaultValue	=   data[0].zoc || '';
				zod.defaultValue	=   data[0].zod || '';


				dom.defaultValue	=   data[0].dom || '';
				cpo.defaultValue	=   data[0].cpo || '';
				pob.defaultValue	=   data[0].pob || '';
				pro.defaultValue	=   data[0].pro || '';
				pai.defaultValue	=   data[0].pai || '';
				te1.defaultValue	=   data[0].te1 || '';
				te2.defaultValue	=   data[0].te2 || '';
				fax.defaultValue	=   data[0].fax || '';
				cor.defaultValue	=   data[0].cor || '';
				per.defaultValue	=   data[0].per || '';
				ent.defaultValue	= 	data[0].ent;
				ofi.defaultValue	= 	data[0].ofi;
				ndc.defaultValue	= 	data[0].ndc;
				cue.defaultValue	= 	data[0].cue;
				iba.defaultValue	=   data[0].iba || '';
				bic.defaultValue	=   data[0].bic || '';
				nba.defaultValue	=   '';
				dp1.defaultValue	=	data[0].dp1;
				dp2.defaultValue	=	data[0].dp2;
				dp3.defaultValue	=	data[0].dp3;
				seleccionarCombo('mnp', data[0].mnp);
				dic.defaultValue	=	data[0].dic;
				din.defaultValue	=	data[0].din;
				sub.defaultValue	=   data[0].sub || '';
				irp.defaultValue 	=	parseFloat(data[0].irp).toFixed(2).replace('.', ',') + ' %';
				not.defaultValue	=   data[0].not || '';

				if (window.opcionAgente === 2) {
					cod.readOnly	=	true;
					alt.readOnly	= 	false;
					nom.readOnly	=	false;
					nif.readOnly	=   false;
					dom.readOnly	=   false;
					cpo.readOnly	=   false;
					pob.readOnly	=   false;
					pro.readOnly	=   false;
					pai.readOnly	=   false;
					te1.readOnly	=   false;
					te2.readOnly	=   false;
					fax.readOnly	=   false;
					cor.readOnly	=   false;
					per.readOnly	=   false;
					ent.readOnly	=   false;
					ofi.readOnly	=   false;
					ndc.readOnly	=   false;
					cue.readOnly	=   false;
					iba.readOnly	=   false;
					bic.readOnly	=   false;
					dp1.readOnly	=   false;
					dp2.readOnly	=   false;
					dp3.readOnly	=   false;
					mnp.disabled	= 	false;
					sub.readOnly	=   false;
					irp.readOnly	=	false;
					not.readOnly	=   false;

					aceptar.hidden	= 	false;
		      		cancelar.hidden = 	false;
				}		

				if (window.opcionAgente === 4) {
					cod.readOnly	=	true;
					alt.readOnly	= 	true;
					nom.readOnly	=	true;
					nif.readOnly	=   true;
					dom.readOnly	=   true;
					cpo.readOnly	=   true;
					pob.readOnly	=   true;
					pro.readOnly	=   true;
					pai.readOnly	=   true;
					te1.readOnly	=   true;
					te2.readOnly	=   true;
					fax.readOnly	=   true;
					cor.readOnly	=   true;
					per.readOnly	=   true;
					ent.readOnly	=   true;
					ofi.readOnly	=   true;
					ndc.readOnly	=   true;
					cue.readOnly	=   true;
					iba.readOnly	=   true;
					bic.readOnly	=   true;

					dp1.readOnly	=   true;
					dp2.readOnly	=   true;
					dp3.readOnly	=   true;
					mnp.disabled	= 	true;
					sub.readOnly	=   true;
					irp.readOnly	=	true;
					not.readOnly	=   true;

					aceptar.hidden	= 	true;
		      		cancelar.hidden = 	true;
				}				

			})
		}

		document.getElementById('formAgente').reset();

	})


	modalAgente.addEventListener('hide.bs.modal', function (e) {
		if (window.noCerrarModal == '1') {
			window.noCerrarModal = '0';
			e.preventDefault();
	     	e.stopImmediatePropagation();
	     	return false;
		}
	})



	formAgente.onsubmit = async (e) => {
		e.preventDefault();

		let sMask1 			= irp.value;
		let numSinMascara 	= quitarMascara(sMask1, ',');
		irp.value			= numSinMascara;

		ent.value   		= parseInt(ent.value);
		ofi.value   		= parseInt(ofi.value);
		ndc.value   		= parseInt(ndc.value);
		cue.value   		= parseInt(cue.value);

		var fila2 = {
			can:  			can.value,
			cod: 			cod.value,
			nom: 			nom.value,
			nif: 			nif.value,
			zoc: 			zoc.value,
			zod: 			zod.value,			
			dom: 			dom.value,
			cpo: 			cpo.value,
			pob: 			pob.value,
			pro: 			pro.value,
			pai: 			pai.value,
			per: 			per.value,
			te1: 			te1.value,
			te2: 			te2.value,
			fax: 			fax.value,
			cor: 			cor.value,			
			fpc: 			fpc.value,
			fpd: 			fpd.value,
			dic: 			dic.value,
			din: 			din.value,
			sub: 			sub.value,
			alt: 			alt.value
	    };

		async function datosDevueltos1() {
			let formData1 = new FormData(formAgente);
			formData1.append('esBDempresas', 0);
			formData1.append('opcionListado', window.opcionAgente);	
			const response1 = await fetch('php/agente.php', {
				method: 'POST',
				body:   formData1
			});
			const data1 = await response1.json();
			return data1;
		}

	    datosDevueltos1().then((data1) => {
	    	let $table = $('#tabAgentes');
	    	if (data1.toString().substring(0, 4) == 'codN') {
	    		$('#modalAgente').modal('hide');
	    		fila2.can = data1.toString().substring(4);
				window.idTabAgentes = fila2.can;
 				$table.bootstrapTable('append', fila2);
 				refrescar (1);
 			} else if (data1 == '0') {
 				$('#modalAgente').modal('hide');
				$table.bootstrapTable('updateByUniqueId', {
	  				id: 		window.idTabAgentes,
	  				row: 		fila2,
		        	replace: 	false
				});
			} else if (data1 == '1') {
				cod.focus();
				msjAgentes.innerHTML 	= 'Código ya existente';
				let myModalNuevo1 		= new bootstrap.Modal(dialogoAgentes);
				myModalNuevo1.show();
			} else if (data1 == '2') {
				nom.focus();
				msjAgentes.innerHTML 	= 'Nombre ya existente';
				let myModalNuevo2 		= new bootstrap.Modal(dialogoAgentes);
				myModalNuevo2.show();
			} else {
				msjAgentes.innerHTML	= data1;
				let myModalNuevo3 		= new bootstrap.Modal(dialogoAgentes);
				myModalNuevo3.show();
			}
	    }).catch(error => {
			alert(error.message);
	    })			
		    
	}

	irp.addEventListener('focus', 	(event) => { porcentajeFocus(irp.value); 	});
	irp.addEventListener('blur', 	(event) => { porcentajeBlur ('irp'); 		});	

</script>



<!-- Comienzo modal columnas visibles -->
<div class="modal fade modal-dialog-scrollable" id="modalColumnasTablasAgentes" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h6 class="modal-title">Columnas a mostrar</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
            	<form>
            		<div class="form-group" id="listFields">
                	</div>
            	</form>
            </div>
        </div>
    </div>

<script>
	modalColumnasTablasAgentes.addEventListener('show.bs.modal', function (e) {
		crearListadoNombresColumnas('modalColumnasTablasAgentes');
	})
</script>

</div>


<!-- Comienzo modal mensajes -->
<div class="modal" id="dialogoAgentes" tabindex="-1">
  <div class="modal-dialog">
      <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header bg-light">
              <h5 class="modal-title">GestiónPYME</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>       
          <!-- Modal body -->
          <div class="modal-body">
			<div align="center">
			    <p id="msjAgentes">No se puede eliminar el agente por defecto</p>  
			</div>
          </div>
    </div>
  </div>  
</div>


<!-- Comienzo modal eliminar -->
<div class="modal fade" id="formEliminarAgente" tabindex="-1">
  	<div class="modal-dialog">
      	<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header bg-light">
			  	<h5 class="modal-title">Agente</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>       
			<!-- Modal body -->
			<div class="modal-body">
		        <form id="formDel">
		          	<div class="form-group mb-2">
		            	<input type="text" name="codE" id="codE" size=15 maxlength=15 readonly class="form-control" title="Código del agente" data-toggle="tooltip">
		          	</div>
		          	<div class="form-group">
		            	<input type="text" name="nomE" id="nomE" size=60 maxlength=60 readonly class="form-control" title="Nombre del agente" data-toggle="tooltip">
		        	</div>
		        </form>
		     </div>
			<!-- Modal footer -->
			<div class="modal-footer bg-light">
		        <div align="center">
		            <p>¿Eliminar agente? </p>  
		        </div>
		        <button type="button" class="btn btn-primary" id="SiEliminarAgente" data-bs-dismiss="modal">Sí</button>
		        <button type="button" class="btn btn-secondary" id="NoEliminarAgente" data-bs-dismiss="modal">No</button>
	        </div>
<script>
    $('#SiEliminarAgente').on('click', function(event) {
		let formData3 = new FormData();
		formData3.append('esBDempresas', 0);
		formData3.append("can", window.idTabAgentes);
		formData3.append("opcionListado", 3);
		async function eliminaAgente() {
			const response3 = await fetch('php/agente.php', {
	      		method: 'POST',
	      		body: 	formData3,
	    	});
			const data3 = await response3.json();
			return data3;
		}
		eliminaAgente().then((data3) => {
			let eliAgente = eliminarReg('tabAgentes', 'idTabAgentes', 'can', '');
			refrescar(1);				
		}).catch(error => {
			alert(error.message);
		});
    });
</script>
    	</div>
  	</div>  
</div>


<script>
	var $table 		= $('#tabAgentes');
	var indiceFila	= -1;
	var refresco 	= -1;
	var iPos 		= 0;	

	$(function() {

	    $table.on('click-row.bs.table', function (e, row, $element) {
	    	window.idTabAgentes 	= row.can;
	    	indiceFila				= $element.index();
	    	iPos					= $table.bootstrapTable('getScrollPosition');

        	let rows 				= Array.from(document.querySelectorAll('tr.success'));
        	rows.forEach(row => {  row.classList.remove('success');  });    	
	    	$element.addClass('success');

	    	return false;

	    })

		$table.on('dbl-click-row.bs.table', function (e, row, $element) {	
			// gestión ventanas
			seleccionarRegistroYcerrar('nExtAgentes', row.cod, row.nom, row.can);
		})	    

	    $table.on('sort.bs.table',   function () {
	    	refresco 	= -1;
	  		return false;
	    })

	    $table.on('search.bs.table', function () {
	    	refresco 	= -1;
	  		return false;
	    }) 

	    $table.on('page-change.bs.table', function () {
	    	refresco 	= -1;
	  		return false;
	    })  	    

    	$table.on('post-body.bs.table', function (data) {
			setTimeout(
		    function () {

		    	// refresco después de inicio, buscar u ordenar
		    	if (refresco == -1) {
					iPos 					= 0;
					window.idTabAgentes 	= '';
					indiceFila				= seleccionarFila('tabAgentes', 'idTabAgentes', 'can', 'success');
	    			refresco 				= 0;
	    			return false;
		    	}

		    	// refresco después de añadir o eliminar
		    	if (refresco == 1) {
		    		indiceFila				= indice(window.idTabAgentes, 'can', 'tabAgentes');
					iPos 					= Math.abs(tabAgentes.getElementsByTagName('tr')[indiceFila].offsetTop) - 5;
		    	}

		    	// refresco regular
		    	$table.bootstrapTable('scrollTo', iPos);
		    	refresco = 0;
		    	return false;

			}, 500);

			return false;

		})


	    $table.on('refresh.bs.table', function (params) {
	    })			    

	})


	window.icons = {
		detailOpen: 'bi-caret-down-fill',
		detailClose: 'bi-caret-up-fill'
	}; 	

	function rowStyle(row) {
		let customClass = "";
		if (row.can == window.idTabAgentes) { customClass = 'success'; }
		else {}
		return { classes: customClass };
	}

	function detailFormatter(index, row) {
		var html = [];
		$.each(row, function (key, value) {
			if (key == 'can' ||  !value || value == '') { }
			else {
				let a = '';
				let b = '';
				if (key == 'cod')  		{ a = 'Código'; 					b = value; }
				if (key == 'nom')  		{ a = 'Nombre'; 					b = value; }
				if (key == 'nif')  		{ a = 'NIF'; 						b = value; }
				if (key == 'zoc')  		{ a = 'Zona'; 						b = value; }
				if (key == 'zod')  		{ a = 'Descripción zona'; 			b = value; }
				if (key == 'dom')  		{ a = 'Dirección'; 					b = value; }
				if (key == 'cpo')  		{ a = 'C. P.'; 						b = value; }
				if (key == 'pob')  		{ a = 'Población'; 					b = value; }
				if (key == 'pro')  		{ a = 'Provincia'; 					b = value; }
				if (key == 'pai')  		{ a = 'País'; 						b = value; }
				if (key == 'per')  		{ a = 'Persona de contacto'; 		b = value; }
				if (key == 'te1')  		{
					a = 'Telefóno 1';
					b = value + ' <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button><ul class="dropdown-menu"><li><a class="dropdown-item" href="tel:' + valorEnlace(value, 1) + '" target="_blank"><i class="bi bi-telephone" style="font-size: 1rem; color: currentColor;"></i> Llamar</a></li><li><a class="dropdown-item" href="https://wa.me/' + valorEnlace(value, 3) + '" target="_blank"><i class="bi bi-whatsapp" style="font-size: 1rem; color: currentColor;"></i> WhatsApp</a></li><li><a class="dropdown-item" href="sms:' + valorEnlace(value, 2) + '" target="_blank"><i class="bi bi-chat-left-text" style="font-size: 1rem; color: currentColor;"></i> SMS</a></li></ul>';
				}
				if (key == 'te2')  		{ 
					a = 'Teléfono 2';
					b = value + ' <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button><ul class="dropdown-menu"><li><a class="dropdown-item" href="tel:' + valorEnlace(value, 1) + '" target="_blank"><i class="bi bi-telephone" style="font-size: 1rem; color: currentColor;"></i> Llamar</a></li><li><a class="dropdown-item" href="https://wa.me/' + valorEnlace(value, 3) + '" target="_blank"><i class="bi bi-whatsapp" style="font-size: 1rem; color: currentColor;"></i> WhatsApp</a></li><li><a class="dropdown-item" href="sms:' + valorEnlace(value, 2) + '" target="_blank"><i class="bi bi-chat-left-text" style="font-size: 1rem; color: currentColor;"></i> SMS</a></li></ul>';
				}
				if (key == 'fax')  		{ a = 'Fax'; 						b = value; }
				if (key == 'cor')  		{
				 	a = 'E-mail'; 
					b = value + ' <a href="mailto:' + value + '" target="_blank"><i class="bi bi-at" style="font-size: 1rem; color: currentColor;"></i></a>';
				}
				if (key == 'fpc')  		{ a = 'Forma pago'; 				b = value; }
				if (key == 'fpd')  		{ a = 'Descripción forma pago'; 	b = value; }
				if (key == 'dic')  		{ a = 'Divisa'; 					b = value; }
				if (key == 'din')  		{ a = 'Nombre divisa'; 				b = value; }
				if (key == 'sub')  		{ a = 'Subcuenta'; 					b = value; }
				if (key == 'alt')  		{ a = 'Alta'; 						b = value; }
				if (!(!b || b == '')) {
						html.push('<div><b>' + a + ':</b> ' + b + '</div><p></p>');		
				}
			}
		})
		return html.join('');
	}

	function refrescar(n) {
	    refresco = n;
	    $table.bootstrapTable('refresh');
	    return false;
  	} 	  	

</script>


  </body>
</html>