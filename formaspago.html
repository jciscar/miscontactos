<?php
session_start();
?>
<!DOCTYPE html>
<html lang="es">
<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Formas de pago</title>

    <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css">
    <script src="lib/jquery/jquery.min.js"></script>
    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    
    <link rel="stylesheet" href="lib/icons/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="lib/bootstrap-table/dist/bootstrap-table.min.css">
    <script src="lib/bootstrap-table/dist/bootstrap-table.min.js"></script>

    <script src="lib/bootstrap-table/dist/locale/bootstrap-table-es-ES.min.js"></script>
    
    <script src="lib/bootstrap-table/dist/tableExport.min.js"></script>
    <script src="lib/bootstrap-table/dist/extensions/auto-refresh/bootstrap-table-auto-refresh.min.js"></script>

  	<script src="lib/gp/libgp01.js"></script>

  	<link rel="shortcut icon" href="lib/ico/logo.ico">	

<style>

    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }

    @media (max-width: 992px) {
        #titulo { font-size: 18px };
    }  

    @media (min-width: 993px) {
        #aceptar:after  { content: '  Guardar';}
        #cancelar:after { content: '  Cancelar';}
    }

    @media (min-width: 993px) {
        #aceptar1:after     { content: '  Guardar';}
        #cancelar1:after { content: '  Cancelar';}
    }   

    .success {
            background: #92c5fc;
            font-weight: bold;
    }   

    .success1 {
            background: #92c5fc;
            font-weight: bold;
    }       

    .closed { display: none; }
    .opened { display: block; }

    .wrapper {
        overflow-y: hidden;
        overflow-x: hidden;
    }

    .dropdown-menu > li:hover > .submenu{ display: block; margin-left:2rem; } 


	/* The snackbar - position it at the bottom and in the middle of the screen */
	#snackbar {
	  visibility: hidden; /* Hidden by default. Visible on click */
	  min-width: 250px; /* Set a default minimum width */
	  margin-left: -125px; /* Divide value of min-width by 2 */
	  background-color: #333; /* Black background color */
	  color: #fff; /* White text color */
	  text-align: center; /* Centered text */
	  border-radius: 2px; /* Rounded borders */
	  padding: 16px; /* Padding */
	  position: fixed; /* Sit on top of the screen */
	  z-index: 1; /* Add a z-index if needed */
	  left: 50%; /* Center the snackbar */
	  bottom: 30px; /* 30px from the bottom */
	}

	/* Show the snackbar when clicking on a button (class added with JavaScript) */
	#snackbar.show {
	  visibility: visible; /* Show the snackbar */
	  /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
	  However, delay the fade out process for 2.5 seconds */
	  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
	  animation: fadein 0.5s, fadeout 0.5s 2.5s;
	}

	/* Animations to fade the snackbar in and out */
	@-webkit-keyframes fadein {
	  from {bottom: 0; opacity: 0;}
	  to {bottom: 30px; opacity: 1;}
	}

	@keyframes fadein {
	  from {bottom: 0; opacity: 0;}
	  to {bottom: 30px; opacity: 1;}
	}

	@-webkit-keyframes fadeout {
	  from {bottom: 30px; opacity: 1;}
	  to {bottom: 0; opacity: 0;}
	}

	@keyframes fadeout {
	  from {bottom: 30px; opacity: 1;}
	  to {bottom: 0; opacity: 0;}
	}      

</style>

  </head>
  <body class="bg-light" onunload="descargar()">

  <script>

  	// gestión ventanas. Es la función que se ejecutar en onunload de body
  	function descargar() { despuesDeCerrarVentana('nExtFormasPago', 'formaspago'); }

  	var $table = document.getElementById('tabFormasPago');

    document.addEventListener("DOMContentLoaded", function(event) {
    	compProcedencia();

    	// gestión ventanas
    	despuesDeAbrirVentana('nExtFormasPago', 'formaspago');

			$('[data-toggle="tooltip"]').tooltip({ trigger: "hover" });
			permisosVentana('formaspago');

      window.decImpDivPred 	= localStorage.getItem('decImpDivPred');
      window.abrevDivPred   = localStorage.getItem('abrevDivPred');

      window.cambioPlazos = false;

      cambiarAltoTabla();

			return false;
    });

	$(document).ready(function(e) {
		barraPaginacion('#tabFormasPago');
		if (window.nExtFormasPago != 0) { msjDblClic(); }
		return false;
	});	

	window.addEventListener("resize", function(event) {
		cambiarAltoTabla();
		return false;
	});

	//funciona en chrome pero no en firefox
	window.addEventListener("load", function(event) {
		//cambiarAltoTabla();
		return false;
	});	

	function eliminarFormaPago(){	
		let formDataE = new FormData();
		formDataE.append("nform", 'formaspago');
		formDataE.append("codnum", window.idTabFormasPago);
		formDataE.append("opcionlistado", 3);
		async function comprobarAntesDeEliminar() {
			const comprobarResponse = await fetch('php/comprobar_antes_de_editar_o_eliminar.php', {
	      		method: 'POST',
	      		body: 	formDataE
	    	});
			const dataE = await comprobarResponse.json();
			return dataE;
		}
		comprobarAntesDeEliminar().then((dataE) => {
			if (dataE == '[object Object]') {
				let myModal = new bootstrap.Modal(document.getElementById('formEliminarFormaPago'));
				myModal.show();
				codE.defaultValue = dataE.cod;
				desE.defaultValue = dataE.des;
			} else {
				document.getElementById('msjFormaPago').innerText = dataE;
				let myModal = new bootstrap.Modal(document.getElementById('dialogoFormaPago'));
				myModal.show();
			};				
		}).catch(error => {
			alert(error.message);
		});
    return false;
	}


	$(document).on('click', 'input:radio[id^="tip"]', function(event) {
		if (this.value == 1) {
			camposImpFijo.hidden = false;
			camposImpPorcentual.hidden = true;
			window.cambioPlazos = false;
		} else {
			camposImpFijo.hidden = true;
			camposImpPorcentual.hidden = false;
			window.cambioPlazos = true;
		}
	})


</script>

<div class="wrapper">


<div class="container-fluid sticky-top bg-light" id="contenedor">
  	<div class="row justify-content-between align-content-center gx-0 gy-2" id="fila">

	  	<div class="col-auto d-none d-md-block mt-2 mb-2">
			 <div class="btn-group" role="group">
				<button class="btn btn-success btn-sm" id="NuevaFormaPago" title="Nueva forma de pago" data-toggle="tooltip" onClick="regTabla('modalFormaPago', 'opcionFormaPago', 1)"><i class="bi bi-person-plus-fill" style="font-size: 1.4rem; color: currentColor;"></i></button>
				<button class="btn btn-success btn-sm" id="EditarFormaPago" title="Editar forma de pago" data-toggle="tooltip" onClick="regTabla('modalFormaPago', 'opcionFormaPago', 2)"><i class="bi bi-person-lines-fill" style="font-size: 1.4rem; color: currentColor;"></i></button>
				<button class="btn btn-success btn-sm" id="EliminarFormaPago" title="Eliminar forma de pago" data-toggle="tooltip" onClick="eliminarFormaPago()"><i class="bi bi-person-dash-fill" style="font-size: 1.4rem; color: currentColor;"></i></button>
				<button class="btn btn-success btn-sm" id="VerFormaPago" title="Ver forma de pago" data-toggle="tooltip" onClick="regTabla('modalFormaPago', 'opcionFormaPago', 4)"><i class="bi bi-person-fill" style="font-size: 1.4rem; color: currentColor;"></i></button>
			</div>
		</div>

		<div class="col-auto align-self-center d-none d-lg-block mt-2 mb-2">
			<a class="navbar-brand" style="font-weight:bold;" id="titulo">Formas de pago</a>
		</div>

		<div class="col-auto d-sm-block d-md-none mt-2 mb-2">
			<button class="btn btn-success dropdown-toggle" type="button" id="MenuMovil" data-bs-toggle="dropdown" aria-expanded="false">
			<i class="bi bi-list" style="font-size: 1rem; color: currentColor;"></i> </button>
		  	<ul class="dropdown-menu" aria-labelledby="MenuMovil">

				<li><a class="dropdown-item" onClick="regTabla('modalFormaPago', 'opcionFormaPago', 1)" href="#"><i class="bi bi-person-plus-fill" style="font-size: 1rem; color: currentColor;"></i> Nueva forma de pago</a></li>
				<li><a class="dropdown-item" onClick="regTabla('modalFormaPago', 'opcionFormaPago', 2)" href="#"><i class="bi bi-person-lines-fill" style="font-size: 1rem; color: currentColor;"></i> Editar forma de pago</a></li>
				<li><a class=" dropdown-item" onClick="eliminarFormaPago()" href="#"><i class="bi bi-person-dash-fill" style="font-size: 1rem; color: currentColor;"></i> Eliminar forma de pago</a></li>
				<li><a class="dropdown-item" onClick="regTabla('modalFormaPago', 'opcionFormaPago', 4)" href="#"><i class="bi bi-person-fill" style="font-size: 1rem; color: currentColor;"></i> Ver forma de pago</a></li>		

				<li><hr class="dropdown-divider"></li>

				<li class="dropend"><a class="dropdown-item dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" href="#" id="opcionesTablaSubmenu"><i class="bi bi-table" style="font-size: 1rem; color: currentColor;"></i> Tabla </a>
				  <ul class="submenu dropdown-menu" aria-labelledby="opcionesTablaSubmenu" id="opcion1">

		  			<li><a class="dropdown-item" onClick="valorTarjeta('tabFormasPago')" href="#"><i class="bi bi-card-list" style="font-size: 1rem; color: currentColor;"></i> Tarjeta/Tabla</a></li>

						<li><a class="dropdown-item" href="#" onClick="mostrarColumnas('modalColumnasTablasFormasPago', 0)"><i class="bi bi-layout-three-columns" style="font-size: 1rem; color: currentColor;"></i> Mostrar columnas</a></li>			  			

				  	<li><a class="dropdown-item" href="#" onClick="imprimirTabla('Formas de pago', tabFormasPago)"><i class="bi bi-printer" style="font-size: 1rem; color: currentColor;"></i> Imprimir</a></li>

				  	<li class="dropend"><a class="dropdown-item dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" href="#" id="opcionesExportarSubmenu"><i class="bi-file-earmark-arrow-down" style="font-size: 1rem; color: currentColor;"></i> Exportar a </a>
				  	 	<ul class="submenu submenu1 dropdown-menu" aria-labelledby="opcionesExportarSubmenu">
							<li><a class="dropdown-item" onClick="exportarTabla('excel','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">MS-Excel</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('csv','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">CSV</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('txt','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">TXT</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('json','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">JSON</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('sql','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">SQL</a></li>
				  	 	</ul>
				  	</li>
				 </ul>
			</li>
		</ul>
	</div>	


		<div class="col-auto mt-2 mb-2">

			<div class="btn-group" role="group">
				<div class="form-check form-switch btn-sm d-none d-md-block">
					<input class="form-check-input" type="checkbox" id="vistaTarjeta" title="Vista de tarjeta" data-toggle="tooltip" onchange="valorTarjeta('tabFormasPago')">
					<label class="form-check-label" for="vistaTarjeta"></label>
				</div>
			</div>

			<div class="btn-group" role="group">

				<button class="btn btn-success btn-sm d-none d-md-block" id="columnasFormasPago" title="Mostrar columnas" data-toggle="tooltip" onClick="mostrarColumnas('modalColumnasTablasFormasPago', 0)"><i class="bi-layout-three-columns" style="font-size: 1.4rem; color: currentColor;"></i></button>

				<button class="btn btn-success btn-sm d-none d-md-block" id="imprimirFormasPago" title="Imprimir tabla" data-toggle="tooltip" onClick="imprimirTabla('Formas de pago', tabFormasPago)"><i class="bi bi-printer" style="font-size: 1.4rem; color: currentColor;"></i></button>
				<button class="btn btn-success btn-sm dropdown-toggle d-none d-md-block" type="button" id="exportarFormasPago" data-bs-toggle="dropdown" aria-expanded="false" title="Exportar tabla" data-toggle="tooltip">
				<i class="bi-file-earmark-arrow-down" style="font-size: 1.4rem; color: currentColor;"></i>
				</button>
			  	<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
			  		<li><h5 class="dropdown-header">Exportar a:</h5></li>
					<li><a class="dropdown-item" onClick="exportarTabla('excel','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">MS-Excel</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('csv','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">CSV</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('txt','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">TXT</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('json','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">JSON</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('sql','Formas de pago','Tabla de Formas de pago',100, 'tabFormasPago')" href="#">SQL</a></li>
			  	</ul>
			</div>
		</div>
		<div class="col-auto align-self-center mt-2 mb-2">
			<div class="btn-group" role="group">
		  		<input type="search" id="buscar" class="form-control" placeholder="Buscar" onchange="buscarAhora('tabFormasPago','buscar')" title="Buscar en la tabla" data-toggle="tooltip">
		  	</div>
		</div>
		<div class="col-auto mt-2 mb-2">
		  	<div class="btn-group" role="group">
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onClick="cerrarVentana('nExtFormasPago')" title="Cerrar" data-toggle="tooltip" style="text-align:right;"></button>
			</div>
		</div>
	</div>
</div>

<script>

    opcionesTablaSubmenu.addEventListener('click',  (e) => { 
        e.stopPropagation();
    });

    opcionesExportarSubmenu.addEventListener('click',   (e) => { 
        e.stopPropagation();
    });

</script>

<div id="snackbar">Doble clic para seleccionar forma pago</div>

<!-- data-virtual-scroll siempre debe cod con el valor "false" para que funcione correctamente el scrolling vertical -->

<div class="container-fluid" id="contenedor">
	<table class="table table-striped table-hover table-responsive" data-page-number="1" id="tabFormasPago" data-url="./php/datosTabla.php?vista=formaspago" data-method="post" data-locale="es-sp" data-toggle="table" data-id-field="cod" data-undefined-text=""

    data-unique-id="cod"

    data-search="true"
    data-show-search-button="false"
    data-search-selector="#buscar"
    data-search-highlight="true"
    data-search-on-enter-key="false"

    data-side-pagination="client"
    data-pagination="false"
    data-show-pagination-switch="false"

    data-id-table="tabFormasPago"

    data-click-to-select="true"
    data-single-select="true"

    data-sort-name="cod"
    data-sort-order="asc"

    data-virtual-scroll="false"

  	data-icons-prefix="bi"
  	data-icons="icons"

    data-auto-refresh="true"
    data-auto-refresh-interval="60"
	data-show-refresh="false"
    data-show-auto-refresh="false"
    data-auto-refresh-silent="true"

    data-export-data-type="all"

    data-detail-view="true"
    data-detail-formatter="detailFormatter"
    data-row-style="rowStyle"

    data-cache="false"
   
    >
    
    <thead class="bg-dark text-light">
	    <tr>
		    <th data-field="cod" data-sortable="true" data-click-to-select="true" data-switchable="false">Código</th>
		    <th data-field="des" data-sortable="true" data-click-to-select="true" data-switchable="false">Descripción</th>
		    <th data-field="tip" data-sortable="true" data-click-to-select="true" data-formatter="tipoImporteFormato" data-visible="false">Importe</th>
			<th data-field="ctc" data-sortable="true" data-click-to-select="true" data-visible="false">Cta. tesorería compras</th>
			<th data-field="ctv" data-sortable="true" data-click-to-select="true" data-visible="false">Cta. tesorería ventas</th>
		    <th data-field="pav" data-sortable="true" data-click-to-select="true" data-align="center" data-formatter="boolFormato" data-visible="false">Cobrado/pagado al vencimiento</th>
		    <th data-field="pac" data-sortable="true" data-click-to-select="true" data-align="center" data-formatter="boolFormato">Por defecto a cuenta</th>
		    <th data-field="pcl" data-sortable="true" data-click-to-select="true" data-align="center" data-formatter="boolFormato">Por defecto clientes</th>
		    <th data-field="ppr" data-sortable="true" data-click-to-select="true" data-align="center" data-formatter="boolFormato">Por defecto proveedores</th>
			<th data-field="tic" data-sortable="true" data-click-to-select="true" data-align="center" data-formatter="boolFormato" data-visible="false">Tickets</th>
			<th data-field="tvi" data-sortable="true" data-click-to-select="true" data-align="center" data-formatter="boolFormato" data-visible="false">Tienda virtual</th>
		</tr>
    </thead>
    <tbody>
    </tbody>

  </table>




</div>

</div>


<!-- Comienzo modal form formapago -->
<div class="modal fade" id="modalFormaPago" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  	<div class="modal-dialog modal-xl">
      	<div class="modal-content">

            <!-- Modal Header -->
          	<div class="modal-header bg-dark bg-gradient sticky-top">
	          	<div class="col-6">
	              <a class="navbar-brand text-warning" id="exampleModalLabel">Forma de pago</a>
	            </div>
							<div class="col-auto" style="text-align:right;">
								<form id="formFormaPago" onreset="camposImporteAlCancelar()">
								<button type="submit" class="btn btn-success mr-3" id="aceptar" value="Aceptar" title="Guardar cambios" data-toggle="tooltip"><i class="bi bi-check-circle" style="font-size: 1rem; color: white;" ></i> </button>
								<button type="reset" class="btn btn-warning btn-sm" id="cancelar" value="Cancelar" title="Cancelar cambios" data-toggle="tooltip"><i class="bi bi-x-circle" style="font-size: 1rem;"></i> </button>	
							</div>
							<div class="col-1" style="text-align:right;">
            		<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" data-toggle="tooltip" title="Cerrar ventana">
              	</button>
              </div>
						</div>
      
          	<!-- Modal body -->
          	<div class="modal-body bg-primary bg-opacity-25">
			        <div class="container-fluid">
								<div class="row align-items-end gx-3 gy-3 mb-4 mt-1">
									<div class="col-auto">
										<input type="text" name="cod" id="cod" placeholder="Código" size=5 maxlength="5" required class="form-control" title="Código de la forma de pago. Máximo 5 caracteres" data-toggle="tooltip">
									</div>					
									<div class="col-auto">
										<input type="text" name="des" id="des" placeholder="Descripción" maxlength=40 size=40 required class="form-control" title="Descripción de la forma de pago. Máximo 40 caracteres" data-toggle="tooltip">
									</div>
					    			<div class="col-auto">
						    			<label class="radio-inline control-label">Medio de pago</label>
											<input type="radio" class="btn-check" name="mep" id="mep01" value=1>
											<label class="btn btn-outline-primary" for="mep01" autocomplete="off">En efectivo</label>
											<input type="radio" class="btn-check" name="mep" id="mep02" value=2>
											<label class="btn btn-outline-primary" for="mep02" autocomplete="off">Tarjeta de crédito</label>
											<input type="radio" class="btn-check" name="mep" id="mep03" value=3>
											<label class="btn btn-outline-primary" for="mep03" autocomplete="off">Efectos bancarios</label>						
					    			</div>

								</div>

								<div class="row align-items-end gx-3 gy-3 mb-4">
					    			<div class="col-auto">
						    			<label class="radio-inline control-label">Tipo</label>
											<input type="radio" class="btn-check" name="tip" id="tip01" value=1>
											<label class="btn btn-outline-primary" for="tip01" autocomplete="off">Importe fijo</label>
											<input type="radio" class="btn-check" name="tip" id="tip02" value=2>
											<label class="btn btn-outline-primary" for="tip02" autocomplete="off">Importe porcentual</label>				
					    			</div>
					    		</div>
				    			<div class="row align-items-end gx-3 gy-3 mb-4" id="camposImpFijo">
				    				<div class="col-auto">
					    				<label for="imf">Importe</label>
											<input type="text" name="imf" id="imf" required size=18 style="text-align:right;" class="form-control" title="Importe fijo" data-toggle="tooltip">
										</div>
										<div class="col-auto">
					    				<input type="number" name="nuf" id="nuf" required min=1 max=999 size=3 style="text-align:right;" class="form-control" title="Unidades del período especificado a continuación" data-toggle="tooltip">
					    			</div>
					    			<div class="col-auto">
					    				<label for="pef">Período</label>
				              <select name="pef" id="pef" class="form-select" title="Tipo de período" data-toggle="tooltip">
				                  <option value=1>día(s)</option>
				                  <option value=2>semana(s)</option>
				                  <option value=3>mes(es)</option>
				                  <option value=4>trimestre(s)</option>
				                  <option value=5>año(s)</option>
				              </select>
				    				</div>
				    			</div>

				    			<div class="row align-items-start gx-3 gy-3 mb-4" id="camposImpPorcentual">
				    				<div class="col-auto">
					    				<label for="npp">Núm. plazos</label>
					    				<input type="number" name="npp" id="npp" required min=1 max=999 step=1 size=3 style="text-align:right;" class="form-control" title="Número de plazos" data-toggle="tooltip">
				    				</div>

				    				<div class="col-auto">
				    					<!-- aquí la tabla de plazos -->


<!-- TABLA plazos -->
  	<div class="row justify-content-between align-content-center gx-0 gy-2" id="fila1">
		<div class="col-auto d-sm-block d-md-none mt-1 mb-1">
			<button class="btn btn-dark dropdown-toggle" type="button" id="MenuMovil1" data-bs-toggle="dropdown" aria-expanded="false">
			<i class="bi bi-list" style="font-size: 1rem; color: currentColor;"></i> </button>
		  	<ul class="dropdown-menu" aria-labelledby="MenuMovilDD">

				<li id="editarPla1"><a class="dropdown-item" onClick="regTabla('modalPlazo', 'opcionPlazos1', 2)" href="#" ><i class="bi bi-person-lines-fill" style="font-size: 1rem; color: currentColor;"></i> Editar plazo</a></li>
				<li><a class=" dropdown-item" onClick="regTabla('modalPlazo', 'opcionPlazos1', 4)" href="#"><i class="bi bi-person-fill" style="font-size: 1rem; color: currentColor;"></i> Ver plazo</a></li>

				<li><hr class="dropdown-divider"></li>

				<li class="dropend"><a class="dropdown-item dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" href="#" id="opcionesTablaSubmenuCC"><i class="bi bi-table" style="font-size: 1rem; color: currentColor;"></i> Tabla </a>
				  <ul class="submenu dropdown-menu" aria-labelledby="opcionesTablaSubmenuCC" id="opcion1">

				  	<li><a class="dropdown-item" href="#" onClick="imprimirTabla('Plazos', tabPlazos)"><i class="bi bi-printer" style="font-size: 1rem; color: currentColor;"></i> Imprimir</a></li>

				  	<li class="dropend"><a class="dropdown-item dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" href="#" id="opcionesExportarSubmenuCC"><i class="bi-file-earmark-arrow-down" style="font-size: 1rem; color: currentColor;"></i> Exportar a </a>
				  	 	<ul class="submenu submenu1 dropdown-menu" aria-labelledby="opcionesExportarSubmenuCC">
							<li><a class="dropdown-item" onClick="exportarTabla('excel','Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">MS-Excel</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('csv',  'Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">CSV</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('txt',  'Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">TXT</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('json', 'Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">JSON</a></li>
							<li><a class="dropdown-item" onClick="exportarTabla('sql',  'Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">SQL</a></li>
				  	 	</ul>
				  	</li>
				 </ul>
			</li>
		</ul>
	</div>	


	  <div class="col-auto d-none d-md-block mt-1 mb-1">
			<div class="btn-group" role="group">

				<button type="button" class="btn btn-sm" onClick="regTabla('modalPlazo', 'opcionPlazos1', 2)" title="Editar plazo" data-toggle="tooltip" id="editarPla2">
			  <i class="bi bi-person-lines-fill" style="font-size: 1rem; color: currentColor;"></i>
				</button>
				<button type="button" class="btn btn-sm" onClick="regTabla('modalPlazo', 'opcionPlazos1', 4)" title="Ver plazo" data-toggle="tooltip">
			  <i class="bi bi-person-fill" style="font-size: 1rem; color: currentColor;"></i>
				</button>

			</div>
		</div>

		<div class="col-auto align-self-center  mt-1 mb-1">
			<h6 class="modal-title" id="titulo">Plazos</h6>
		</div>

		<div class="col-auto mt-1 mb-1">

			<div class="btn-group" role="group">

				<button class="btn btn-sm d-none d-md-block" title="Imprimir tabla" data-toggle="tooltip" onClick="imprimirTabla('Plazos', tabPlazos)"><i class="bi bi-printer" style="font-size: 1rem; color: currentColor;"></i></button>

				<button class="btn btn-sm dropdown-toggle d-none d-md-block" type="button" id="exportarPlazos2" data-bs-toggle="dropdown" aria-expanded="false" title="Exportar tabla">
				<i class="bi-file-earmark-arrow-down" style="font-size: 1rem; color: currentColor;"></i>
				</button>
			  	<ul class="dropdown-menu" aria-labelledby="exportarPlazos2">
			  		<li><h5 class="dropdown-header">Exportar a:</h5></li>
					<li><a class="dropdown-item" onClick="exportarTabla('excel','Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">MS-Excel</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('csv',  'Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">CSV</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('txt',  'Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">TXT</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('json', 'Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">JSON</a></li>
					<li><a class="dropdown-item" onClick="exportarTabla('sql',  'Plazos','Tabla de plazos',100, 'tabPlazos')" href="#">SQL</a></li>
			  	</ul>
			</div>
		</div>

	</div>

			    <table class="table table-striped table-hover table-responsive" data-page-number="1" id="tabPlazos" data-method="post" data-locale="es-sp" data-toggle="table" data-id-field="num1" data-undefined-text=""

				    data-unique-id="num1"
				    
				    data-search="true"
				    data-show-search-button="false"
				    data-search-selector="#buscar1"
				    data-search-highlight="true"
				    data-search-on-enter-key="false"

				    data-side-pagination="client"
				    data-pagination="false"
				    data-show-pagination-switch="false"

				    data-id-table="tabPlazos"

				    data-click-to-select="true"
				    data-single-select="true"

				    data-virtual-scroll="false"

  					data-icons-prefix="bi"
  					data-icons="icons"

				    data-export-data-type="all"

				    data-sort-name="num1"
				    data-sort-order="asc"

				    data-auto-refresh="false"
				    data-show-auto-refresh="false"
  			    data-row-style="rowStyle1"

			    >

		        <thead class="bg-white">
			        <tr>
						    <th data-field="num1" data-click-to-select="true" data-switchable="false" data-align="right">Nº</th>
								<th data-field="por1" data-click-to-select="true" data-align="right" data-formatter="dFormatoPor1">%</th>
								<th data-field="npe1" data-click-to-select="true" data-align="right"></th>
								<th data-field="tpe1" data-click-to-select="true" data-formatter="dTipoPeriodo">Período</th>
							</tr>
		      	</thead>
		      	<tbody>
		    		</tbody>
			    </table>

<script>
	var $table1 		=  $('#tabPlazos');
	var iPos1       =  0;			

	$(function() {

    $table1.on('click-row.bs.table', function (e, row, $element) {
      window.idTabPlazos	= row.num1;
			$('.success1').removeClass('success1');     
      $element.addClass('success1');	    	
    	return false;
    })

    $table1.on('sort.bs.table', function (name, order) { 
    	setTimeout(
        function () {
    			window.idTabPlazos = $table1.bootstrapTable('getData')[0].num1;
					seleccionarFila('tabPlazos', 'idTabPlazos', 'num1', 'success1');
			}, 200)
    })

    $table1.on('search.bs.table', function (text) {
    	window.idTabPlazos = $table1.bootstrapTable('getData')[0].num1;
			seleccionarFila('tabPlazos', 'idTabPlazos', 'num1', 'success1');    	
    }) 


	})

	window.icons = {
		detailOpen: 	'bi-caret-down-fill',
		detailClose: 	'bi-caret-up-fill'
	};

  function rowStyle1(row, index) {
    let customClass1 = "";
    if (row.num1 == window.idTabPlazos) { customClass1 = 'success1'; }
    else {}
    return { classes: customClass1 };
  }

	function idiFormato1(value, row) { return dIdioma(value); }

	function dTipoPeriodo(value, row) {
		if (value == 1) { return "día(s)"; }
		if (value == 2) { return "semana(s)"; }		
		if (value == 3) { return "mes(es)"; }		
		if (value == 4) { return "trimestre(s)"; }		
		if (value == 5) { return "año(s)"; }		
	}

	function dFormatoPor1(value, row) {
		return parseFloat(value).toFixed(2).replace('.', ',');
	}

</script>		



										</div>				    					

									</div>

								

								<div class="row align-items-end gx-3 gy-3 mb-2">
									<div class="col-auto">
										<div class="row align-items-end gx-2 gy-1 mb-3">
											<div class="col-auto">
												<label for="ctc">Cta. Tesorería Compras</label>
												<div class="input-group">
													<input type="text" name="ctc" id="ctc" size=5 readonly class="form-control" title="Código de la cuenta de tesorería" data-toggle="tooltip">
													<div class="input-group-append">
														<button type="button" class="btn btn-outline-secondary" id="abrirCtasTesoreria1" title="Abrir el fichero de cuentas de tesorería" data-toggle="tooltip"><i class="bi bi-search" style="font-size: 1rem; color: currentColor;"></i></button>
													</div>
												</div>
											</div>
											<div class="col-auto">
												<input type="text" id="ctcDes" size=40 readonly class="form-control" title="Descripción de la cuenta de tesorería" data-toggle="tooltip">
											</div>
										</div>
									</div>	
								</div>

								<div class="row align-items-end gx-3 gy-3 mb-2">
									<div class="col-auto">
										<div class="row align-items-end gx-2 gy-1 mb-3">
											<div class="col-auto">
												<label for="ctv">Cta. Tesorería Ventas</label>
												<div class="input-group">
													<input type="text" name="ctv" id="ctv" size=5 readonly class="form-control" title="Código de la cuenta de tesorería" data-toggle="tooltip">
													<div class="input-group-append">
														<button type="button" class="btn btn-outline-secondary" id="abrirCtasTesoreria2" title="Abrir el fichero de cuentas de tesorería" data-toggle="tooltip"><i class="bi bi-search" style="font-size: 1rem; color: currentColor;"></i></button>
													</div>
												</div>
											</div>
											<div class="col-auto">
												<input type="text" id="ctvDes" size=40 readonly class="form-control" title="Descripción de la cuenta de tesorería" data-toggle="tooltip">
											</div>
										</div>
									</div>	
								</div>


								<div class="row align-items-end gx-3 gy-3 mb-3">

			            <div class="col-auto">
										<div class="form-check form-switch">
										  	<label class="form-check-label">
										    	<input type="checkbox" name="pav" id="pav" class="form-check-input" value=0 title="Cobrado o pagado al vencimiento" data-toggle="tooltip">Cobrado/pagado al vencimiento</label>
										</div>
									</div>

			            <div class="col-auto">
										<div class="form-check form-switch">
										  	<label class="form-check-label">
										    	<input type="checkbox" name="pac" id="pac" class="form-check-input" value=0 title="Forma de pago por defecto cuando se trata de un cobro o pago a cuenta" data-toggle="tooltip">Por defecto A Cuenta</label>
										</div>
									</div>

			            <div class="col-auto">
										<div class="form-check form-switch">
										  	<label class="form-check-label">
										    	<input type="checkbox" name="pcl" id="pcl" class="form-check-input" value=0 title="Forma de pago por defecto al dar de alta un cliente" data-toggle="tooltip">Por defecto Clientes</label>
										</div>
									</div>

			            <div class="col-auto">
										<div class="form-check form-switch">
										  	<label class="form-check-label">
										    	<input type="checkbox" name="ppr" id="ppr" class="form-check-input" value=0 title="Forma de pago por defecto al dar de alta un proveedor" data-toggle="tooltip">Por defecto Proveedores</label>
										</div>
									</div>

			            <div class="col-auto">
										<div class="form-check form-switch">
										  	<label class="form-check-label">
										    	<input type="checkbox" name="tic" id="tic" class="form-check-input" value=0 title="Tickets" data-toggle="tooltip">Tickets</label>
										</div>
									</div>

			            <div class="col-auto">
										<div class="form-check form-switch">
										  	<label class="form-check-label">
										    	<input type="checkbox" name="tvi" id="tvi" class="form-check-input" value=0 title="Incluir en tienda virtual" data-toggle="tooltip">Tienda Virtual</label>
										</div>
									</div>																																				

								</div>
	
				</div>
			</div>
			</form>
		</div>
	</div>
</div>

<script>

function revisarPredformasPago() {
    var $table2 = $('#tabFormasPago');
    if (pcl.value == -1) {
		  var numFilas = Object.keys($table2.bootstrapTable('getData')).length;
		  if (numFilas != 0)  {
		    for (var i = 0; i < numFilas; i++) {
		      var a = $table2.bootstrapTable('getData')[i];
		      if (a.cod != window.idTabFormasPago) {
		        if (a.pcl == -1) {
		          $table2.bootstrapTable('updateByUniqueId', {
                id: a.cod,
                row: {pcl: 0},
                replace: false
		          });
		        }
		      }
		    }
		  }
    }

    if (ppr.value == -1) {
		  var numFilas = Object.keys($table2.bootstrapTable('getData')).length;
		  if (numFilas != 0)  {
		    for (var i = 0; i < numFilas; i++) {
		        var a = $table2.bootstrapTable('getData')[i];
		      if (a.cod != window.idTabFormasPago) {
		        if (a.ppr == -1) {
		          $table2.bootstrapTable('updateByUniqueId', {
                id: a.cod,
                row: {ppr: 0},
                replace: false
		          });
		        }
		      }
		    }
		  }
		}

	  if (pac.value == -1) {
				var numFilas = Object.keys($table2.bootstrapTable('getData')).length;
				if (numFilas != 0)  {
				  for (var i = 0; i < numFilas; i++) {
				      var a = $table2.bootstrapTable('getData')[i];
				    if (a.cod != window.idTabFormasPago) {
				      if (a.pac == -1) {
				        $table2.bootstrapTable('updateByUniqueId', {
                  id: a.cod,
                  row: {pac: 0},
                  replace: false
				        });
				      }
				    }
				  }
				}
		  }

      return false;
    }  



	npp.addEventListener('focus', (event) => {
		window.nPlazosOri = npp.value;
	});

	npp.addEventListener('blur', (event) => {
		
		if (window.nPlazosOri !== npp.value) {

			window.cambioPlazos = true;

			let tabla = $('#tabPlazos');

			tabla.bootstrapTable('removeAll');

			let s = 0, p = 0;

			for (let i = 1; i <= npp.value; i++) {

        if (i == npp.value) {
        	p = (100 - s).toFixed(2);
        } else {
          p = (100 / npp.value).toFixed(2);
        }
        
        var fila3 = {
          num1:   i,
          por1:   p,
          npe1:   i * 30,
          tpe1:   1
        };
        s = parseFloat(s) + parseFloat(p);
        tabla.bootstrapTable('append', fila3);
		
			}
    	window.idTabPlazos = tabla.bootstrapTable('getData')[0].num1;
			seleccionarFila('tabPlazos', 'idTabPlazos', 'num1', 'success1'); 			
		}
	});

	function camposImporteAlCancelar() {
		setTimeout(function() {
			if (tip01.defaultChecked) {
				camposImpFijo.hidden = false;
				camposImpPorcentual.hidden = true;
				window.cambioPlazos = false;
			} else {
				camposImpFijo.hidden = true;
				camposImpPorcentual.hidden = false;
				window.cambioPlazos = true;
			}
		}, 1000);
	}

	modalFormaPago.addEventListener('show.bs.modal', function (e) {	
		
	window.noCerrarModal = '0';
    var tabla = $('#tabPlazos');
    tabla.bootstrapTable('removeAll');

	if (window.opcionFormaPago === 1) {

		cod.defaultValue        = '';
		des.defaultValue        = '';
		nuf.defaultValue		= 1;
		seleccionarCombo('pef', 1);
		npp.defaultValue        = 1;

		ctc.defaultValue        = localStorage.getItem('codCtaTesComPred');
		ctv.defaultValue        = localStorage.getItem('codCtaTesVenPred');
		ctcDes.defaultValue     = localStorage.getItem('desCtaTesComPred');
		ctvDes.defaultValue     = localStorage.getItem('desCtaTesVenPred');

		let formatoNumNuevo 	= formatoNum(0, window.decImpDivPred, ',', '.', window.abrevDivPred);
		imf.defaultValue		= formatoNumNuevo;
		imf.placeholder 		= formatoNumNuevo;

		seleccionarRadio('mep', 1);
		seleccionarRadio('tip', 2);
		pav.defaultChecked		= false;
		pcl.defaultChecked		= false;
		ppr.defaultChecked		= false;
		pac.defaultChecked		= false;
		tic.defaultChecked		= false;
		tvi.defaultChecked		= false;

		// rellenar tabla con un registro
		var fila4 = {
			num1:   1,
			por1:   100,
			npe1:   30,
			tpe1:   1
		};       
		tabla.bootstrapTable('append', fila4);
		window.idTabPlazos = tabla.bootstrapTable('getData')[0].num1;
		seleccionarFila('tabPlazos', 'idTabPlazos', 'num1', 'success1');
		window.cambioPlazos = true;

		camposImpFijo.hidden = true;
		camposImpPorcentual.hidden = false;      

		cod.readOnly        		= false;
		des.readOnly        		= false;
		imf.readOnly        		= false;
		nuf.readOnly        		= false;
		pef.disabled        		= false;
		npp.readOnly        		= false;
		desactivarRadio('mep', false);
		desactivarRadio('tip', false);      
		pav.disabled				= false;
		pcl.disabled				= false;
		ppr.disabled				= false;
		pac.disabled				= false;
		tic.disabled				= false;
		tvi.disabled				= false;

		editarPla1.style.display    = 'block';
		editarPla2.style.display    = 'block';
		aceptar.hidden              = false;
		cancelar.hidden             = false;

	}

		if (window.opcionFormaPago === 2 || window.opcionFormaPago === 4) {

			let queries2 = "SELECT `COD` AS `cod`,`DESCRIPCION` AS `des`,`Tipo` AS `tip`,`importeFijo` AS `imf`,`numFijo` AS `nuf`,`periodoFijo` AS `pef`,`nPlazosPorcentual` AS `npp`,`PagadoVto` AS `pav`,`ctaTesoreriaCompras` AS `ctc`,`ctaTesoreriaVentas` AS `ctv`,`predClientes` AS `pcl`,`predProveedores` AS `ppr`,`PredACuenta` AS `pac`,`medioPago` AS `mep`,`tickets` AS `tic`,`tv_incluir` AS `tvi` from `forma_de_pago` where `COD` = '" + window.idTabFormasPago + "';";
			queries2    += "SELECT a.DESCRIPCION as desCtaTesCom from `ctas_tesoreria` a inner join `forma_de_pago` b on a.COD = b.`ctaTesoreriaCompras` where b.`COD` = '" + window.idTabFormasPago + "';";
			queries2    += "SELECT a.DESCRIPCION as desCtaTesVen from `ctas_tesoreria` a inner join `forma_de_pago` b on a.COD = b.`ctaTesoreriaVentas` where b.`COD` = '" + window.idTabFormasPago + "';";				

			let formData2 = new FormData();
			formData2.append('queries', queries2);
			formData2.append('esBDempresas', 0);
			async function datosDevueltos2() {
				const response2 = await fetch('php/multiselect.php', {
		      		method: 'POST',
		      		body: formData2
		    	});
				const data = await response2.json();
				return data;
			};
			datosDevueltos2().then((data) => {
				cod.defaultValue 		= data[0].cod;
				des.defaultValue 		= data[0].des;
				imf.defaultValue 		= formatoNum(parseFloat(data[0].imf), window.decImpDivPred, ',', '.', window.abrevDivPred);
				if (data[0].nuf == 0) { data[0].nuf = 1; }
				nuf.defaultValue		= data[0].nuf;
				seleccionarCombo('pef', data[0].pef);
				if (data[0].npp == 0) { data[0].npp = 1; }
				npp.defaultValue 		= data[0].npp;
				ctc.defaultValue 		= data[0].ctc;
				ctv.defaultValue 		= data[0].ctv;
				ctcDes.defaultValue 	= data[1].desCtaTesCom;
				ctvDes.defaultValue 	= data[2].desCtaTesVen;

	      seleccionarRadio('mep', data[0].mep);
	      seleccionarRadio('tip', data[0].tip);
				pav.defaultChecked 	= devBool(data[0].pav);
				pcl.defaultChecked 	= devBool(data[0].pcl);
				ppr.defaultChecked 	= devBool(data[0].ppr);
				pac.defaultChecked 	= devBool(data[0].pac);
				tic.defaultChecked 	= devBool(data[0].tic);
				tvi.defaultChecked 	= devBool(data[0].tvi);

				if (data[0].tip == 1) {
					camposImpFijo.hidden = false;
					camposImpPorcentual.hidden = true;
				} else {
					camposImpFijo.hidden = true;
					camposImpPorcentual.hidden = false;
				}				

				
				if (window.opcionFormaPago === 2) {
			      cod.readOnly        		= true;
			      des.readOnly        		= false;
			      imf.readOnly        		= false;
			      nuf.readOnly        		= false;
			      pef.disabled        		= false;
			      npp.readOnly        		= false;
			      desactivarRadio('mep', false);
			      desactivarRadio('tip', false);
						pav.disabled						= false;
						pcl.disabled						= false;
						ppr.disabled						= false;
						pac.disabled						= false;
						tic.disabled						= false;
						tvi.disabled						= false;
				
						editarPla1.style.display 			= 'block';
						editarPla2.style.display 			= 'block';
      			aceptar.hidden 								= false;
      			cancelar.hidden 							= false;
				}		

				if (window.opcionFormaPago === 4) {
			      cod.readOnly        		= true;
			      des.readOnly        		= true;
			      imf.readOnly        		= true;
			      nuf.readOnly        		= true;
			      pef.disabled        		= true;
			      npp.readOnly        		= true;
			      desactivarRadio('mep', true);
			      desactivarRadio('tip', true);
						pav.disabled						= true;
						pcl.disabled						= true;
						ppr.disabled						= true;
						pac.disabled						= true;
						tic.disabled						= true;
						tvi.disabled						= true;
						
						editarPla1.style.display 			= 'none';
						editarPla2.style.display 			= 'none';
      			aceptar.hidden 								= true;
      			cancelar.hidden 							= true;
				}


				// rellenar la tabla de plazos y seleccionar la primera fila
				$('#tabPlazos').bootstrapTable('refresh', {
					url: './php/datosSubform.php?nConsulta=236&codN=' + window.idTabFormasPago
				});

				setTimeout(
        	function () {
						window.idTabPlazos = $('#tabPlazos').bootstrapTable('getData')[0].num1;
						seleccionarFila('tabPlazos', 'idTabPlazos', 'num1', 'success1');
					}, 200
        );		

			})
		}

		formFormaPago.reset();

	})


	modalFormaPago.addEventListener('hide.bs.modal', function (e) {
		if (window.noCerrarModal == '1') {
			window.noCerrarModal = '0';
			e.preventDefault();
     	e.stopImmediatePropagation();
     	return false;
		}
	})

	modalFormaPago.addEventListener('hidden.bs.modal', function (e) {
		formFormaPago.reset();
	})

	formFormaPago.onsubmit = async (e) => {

		e.preventDefault();

    let sInsertPla 	= '';
    let f 					= '';
    let codFP 			= '';

    //insert into plazos
    if (window.cambioPlazos) {
	    let numFilas2 = Object.keys($("#tabPlazos").bootstrapTable('getData')).length;
	    if (numFilas2 != 0) {
	    	if (window.opcionFormaPago === 1) { codFP = cod.value; } else { codFP = window.idTabFormasPago; }
	      for (let i = 0; i < numFilas2; i++) {
	        f = $("#tabPlazos").bootstrapTable('getData')[i];
	        //insert into
	        if (sInsertPla != '') { sInsertPla += ','; }
	        sInsertPla += "('" + codFP + "', '" + f.num1 + "', '" + (f.por1 / 100).toFixed(4) +  "', '" + f.npe1 + "', '" + f.tpe1 + "')";
	      }
	    }    	
    }

	  let sMask1 				= imf.value;
	  let numSinMascara = quitarMascara(sMask1, ',');
	  imf.value					= numSinMascara;     

		var filaFormaPago = {
		  cod: cod.value,
		  des: des.value,
		  tip: dValorRadio('tip'),
		  imf: imf.value,
		  nuf: nuf.value,
		  pef: pef.value,
		  npp: npp.value,
		  pav: pav.value,
		  ctc: ctc.value,
		  ctv: ctv.value,
		  pcl: pcl.value,
		  ppr: ppr.value,
		  pac: pac.value,
      mep: dValorRadio('mep'),
      tic: tic.value,
			tvi: tvi.value 
    };

    async function datosDevueltos1() {
        let formData1 = new FormData(formFormaPago);
        formData1.append('esBDempresas', 0);
        formData1.append('opcionListado', window.opcionFormaPago);
        formData1.append('pav', pav.value);
        formData1.append('pac', pac.value);
        formData1.append('pcl', pcl.value);
        formData1.append('ppr', ppr.value);
        formData1.append('tic', tic.value);
        formData1.append('tvi', tvi.value);
        formData1.append('tip', dValorRadio('tip'));
        formData1.append('mep', dValorRadio('mep'));
		formData1.append('insertPla', sInsertPla);
		const response1 = await fetch('php/formapago.php', {
			method: 'POST',
			body:   formData1
		});
		const data1 = await response1.json();
		return data1;
    }

    datosDevueltos1().then((data1) => {
      if (data1 == '0') {
        $('#modalFormaPago').modal('hide');
        if (window.opcionFormaPago === 1) {
          window.idTabFormasPago = filaFormaPago.cod;
          $('#tabFormasPago').bootstrapTable('append', filaFormaPago);
          if (pcl.value == -1 || ppr.value == -1 || pac.value == -1) { revisarPredformasPago(); }
          refrescar (1);
        } else if (window.opcionFormaPago === 2) {
          $('#tabFormasPago').bootstrapTable('updateByUniqueId', {
          	id:         window.idTabFormasPago,
          	row:        filaFormaPago,
      			replace:    false
          });
          if (pcl.value == -1 || ppr.value == -1 || pac.value == -1) { revisarPredformasPago(); }
        }
      } else if (data1 == '1') {
        cod.focus();
        msjFormaPago.innerHTML  = 'Código ya existente';
        let myModalNuevo1       = new bootstrap.Modal(dialogoFormaPago);
        myModalNuevo1.show();
      } else if (data1 == '2') {
        des.focus();
        msjFormaPago.innerHTML  = 'Descripción ya existente';
        let myModalNuevo1       = new bootstrap.Modal(dialogoFormaPago);
        myModalNuevo1.show();
      } else {
        msjFormaPago.innerHTML  = data1;
        let myModalNuevo3       = new bootstrap.Modal(dialogoFormaPago);
        myModalNuevo3.show();
      }
    }).catch(error => {
      alert(error.message);
    }) 
	    
	};

	pav.addEventListener('click', (event) => {
		if (pav.checked) {
			pav.value = -1;
		} else {
			pav.value = 0;
		}
	});

	pcl.addEventListener('click', (event) => {
		if (pcl.defaultChecked) {
			event.preventDefault ();
		} else {
			if (pcl.checked) { pcl.value = -1; } else { pcl.value = 0; }
		}
	});

	ppr.addEventListener('click', (event) => {
		if (ppr.defaultChecked) {
			event.preventDefault ();
		} else {
			if (ppr.checked) { ppr.value = -1; } else { ppr.value = 0; }
		}
	});

	pac.addEventListener('click', (event) => {
		if (pac.defaultChecked) {
			event.preventDefault ();
		} else {
			if (pac.checked) { pac.value = -1; } else { pac.value = 0; }
		}
	});	

	tic.addEventListener('click', (event) => {
		if (tic.checked) { tic.value = -1; } else { tic.value = 0; }
	});

	tvi.addEventListener('click', (event) => {
		if (tvi.checked) { tvi.value = -1; } else { tvi.value = 0; }
	});

	imf.addEventListener('focus', (event) => {
		window.sMask1ant = imf.value;
	});

	imf.addEventListener('blur', (event) => { 
    let sMask1 = imf.value;
    if (sMask1 != window.sMask1ant) {
      let numSinMascara = quitarMascara(sMask1, ',');
      imf.value 		= formatoNum(numSinMascara, window.decImpDivPred, ',', '.', window.abrevDivPred);
    }
	});

	cod.addEventListener('blur', (event) => {
		if (window.opcionFormaPago === 1) {
		  	window.idTabFormasPago = cod.value;
		}   
	});	

</script>


<!-- Comienzo modal mensajes -->
<div class="modal" id="dialogoFormaPago" tabindex="-1">
  <div class="modal-dialog">
      <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header bg-light">
              <h5 class="modal-title">GestiónPYME</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-toggle="tooltip" title="Cerrar ventana"></button>
          </div>       
          <!-- Modal body -->
          <div class="modal-body">
			<div align="center">
			    <p id="msjFormaPago">No se puede eliminar la forma de pago</p>  
			</div>
          </div>
    </div>
  </div>  
</div>

<!-- Comienzo modal columnas visibles -->
<div class="modal fade modal-dialog-scrollable" id="modalColumnasTablasFormasPago" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h6 class="modal-title">Columnas a mostrar</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
            	<form>
            		<div class="form-group" id="listFields">
                	</div>
            	</form>
            </div>
        </div>
    </div>
</div>
<script>
		modalColumnasTablasFormasPago.addEventListener('show.bs.modal', function (e) {
				crearListadoNombresColumnas('modalColumnasTablasFormasPago');
		})
</script>


<!-- Comienzo modal eliminar -->
<div class="modal fade" id="formEliminarFormaPago" tabindex="-1">
  	<div class="modal-dialog">
      	<div class="modal-content">
      	  	
          	<!-- Modal Header -->
          	<div class="modal-header bg-light">
              	<h5 class="modal-title">Forma de pago</h5>
          		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-toggle="tooltip" title="Cerrar ventana"></button>
          	</div>       
          	<!-- Modal body -->
          	<div class="modal-body">
		        	<div class="container-fluid">
		        		<form id="formDel">
									<div class="row align-items-end gx-3 gy-3 mb-3">
										<div class="col-auto">
											<input type="text" name="codE" id="codE" maxlength=5 size=5 readonly class="form-control" title="Código de la forma de pago" data-toggle="tooltip">	
										</div>					
										<div class="col-auto">
											<input type="text" name="desE" id="desE" maxlength=40 size=40 readonly class="form-control" title="Descripción de la forma de pago" data-toggle="tooltip">
										</div>
									</div>
								</form>
							</div>
			  		</div>
          
			<!-- Modal footer -->
			<div class="modal-footer bg-light">
		        <div align="center">
		            <p>¿Eliminar forma de pago? </p>  
		        </div>
		        <button type="button" class="btn btn-primary" 	id="SiEliminarFormaPago" data-bs-dismiss="modal">Sí</button>
		        <button type="button" class="btn btn-secondary" id="NoEliminarFormaPago" data-bs-dismiss="modal">No</button>
	        </div>

    	</div>
  	</div>  
</div>
<script>
	  $('#SiEliminarFormaPago').on('click', function(event) {
				let formData3 = new FormData();
				formData3.append('esBDempresas', 0);
				formData3.append("cod", window.idTabFormasPago);
				formData3.append("opcionListado", 3);
				async function eliminaFormaPago() {
					const response3 = await fetch('php/formapago.php', {
			      		method: 'POST',
			      		body: 	formData3,
			    	});
					const data3 = await response3.json();
					return data3;
				}
				eliminaFormaPago().then((data3) => {
						let eliFormaPago = eliminarReg('tabFormasPago', 'idTabFormasPago', 'cod', '');
						refrescar(1);				
				}).catch(error => {
						alert(error.message);
				});
	  });
</script>


<!-- Comienzo modal form plazos -->
<div class="modal fade" id="modalPlazo" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
     <div class="modal-content border-2 border-primary rounded-3">
      <!-- Modal Header -->
    	<div class="modal-header bg-light sticky-top">
	      	<div class="col-6">
	          <a class="navbar-brand" style="font-weight:bold;" id="titulo">Plazo</a>
	        </div>
			<div class="col-auto">
				<form id="formPlazo">
				<button type="submit" class="btn btn-success mr-3 text-white" id="aceptar1" value="Aceptar" title="Guardar cambios" data-toggle="tooltip"><i class="bi bi-check-circle" style="font-size: 1rem; color: white;" ></i> </button>
				<button type="reset"  class="btn btn-secondary btn-sm text-white" id="cancelar1" value="Cancelar" title="Cancelar cambios" data-toggle="tooltip"><i class="bi bi-x-circle" style="font-size: 1rem; color: white;"></i> </button>	
			</div>
			<div class="col-1">
      			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-toggle="tooltip" title="Cerrar ventana">
        		</button>
        	</div>
		</div>

    	<!-- Modal body -->
    	<div class="modal-body">
        <div class="container-fluid">
					<div class="row align-items-end gx-3 gy-3 mb-3">
    				<div class="col-auto">
	    				<label for="num1">Número de plazo</label>
	    				<input type="number" name="num1" id="num1" required readonly size=3 style="text-align:right;" class="form-control" title="Número de plazo" data-toggle="tooltip">
    				</div>
	    			<div class="col-auto">
	    				<label for="por1" style="text-align:right;">Porcentaje</label>
							<input type="text" name="por1" id="por1" required size=8 style="text-align:right;" class="form-control" title="Porcentaje" data-toggle="tooltip">
						</div> 
						<div class="col-auto">
	    				<input type="number" name="npe1" id="npe1" required min=1 max=999 size=3 step=1 style="text-align:right;" class="form-control" title="Unidades del período especificado a continuación" data-toggle="tooltip">
	    			</div>
	    			<div class="col-auto">
	    				<label for="tpe1">Período</label>
              <select name="tpe1" id="tpe1" class="form-select" title="Tipo de período" data-toggle="tooltip">
                  <option value=1>día(s)</option>
                  <option value=2>semana(s)</option>
                  <option value=3>mes(es)</option>
                  <option value=4>trimestre(s)</option>
                  <option value=5>año(s)</option>
              </select>
    				</div>
					</div>
				</div>
			</div>
			</form>
		</div>
	</div>
</div>
<script>

	modalPlazo.addEventListener('hidden.bs.modal', function (e) { destruirModal('modalPlazo'); })

	modalPlazo.addEventListener('show.bs.modal', function (e) {
		if (window.opcionPlazos1 === 2 || window.opcionPlazos1 === 4) {
      let indTab1 						= indice(window.idTabPlazos, 'num1', 'tabPlazos');
      let datosUs 						= $('#tabPlazos').bootstrapTable('getData')[indTab1];
      num1.defaultValue       = datosUs.num1;
      por1.defaultValue       = parseFloat(datosUs.por1).toFixed(2).replace('.', ',') + ' %';
			npe1.defaultValue       = datosUs.npe1;
			seleccionarCombo('tpe1', datosUs.tpe1);

      num1.readOnly     				= true;
      if (window.opcionPlazos1 === 2) {
	      por1.readOnly         	= false;
	      npe1.readOnly         	= false;
	      tpe1.disabled         	= false;
      	aceptar1.hidden 				= false;
      	cancelar1.hidden 				= false;
      } else if (window.opcionPlazos1 === 4) {
	      por1.readOnly         	= true;
	      npe1.readOnly         	= true;
	      tpe1.disabled         	= true;
      	aceptar1.hidden 				= true;
      	cancelar1.hidden 				= true;       
      }
    }
    document.getElementById('formPlazo').reset();
	})

	formPlazo.onsubmit = async (e) => {
		e.preventDefault();

		window.cambioPlazos = true;

	  let sMask1 				= por1.value;
	  let numSinMascara = quitarMascara(sMask1, ',');
	  por1.value 				= numSinMascara;
		
    var fila2 = {
      num1: 			num1.value,
      por1: 			por1.value,
			npe1: 			npe1.value,
			tpe1: 			tpe1.value
    };
    if (window.opcionPlazos1 === 2) {
      $('#tabPlazos').bootstrapTable('updateByUniqueId', {
        id:       window.idTabPlazos,
        row:    	fila2,
        replace: 	false
      });
    }
    $('#modalPlazo').modal('hide');
	}

  por1.addEventListener('focus', (event) => {
      window.sMask1ant = por1.value;
  });

  por1.addEventListener('blur', (event) => {   
    let sMask1 = por1.value;
    if (sMask1 != window.sMask1ant) {
      let numSinMascara = quitarMascara(sMask1, ',');
      if (numSinMascara > 100) { numSinMascara = 100; }
      por1.value = numSinMascara.toFixed(2).toString().replace(".", ",") + " %";
    }
  });


</script> 


<script>
	var $table 		=  $('#tabFormasPago');
	var numTab 		=  0;
	var indiceFila	= -1;
	var refresco 	= -1;
	var iPos 		=  0;

	$(function() {

	    $table.on('click-row.bs.table', function (e, row, $element) {
	    	window.idTabFormasPago 		= row.cod;
	    	indiceFila					= $element.index();
	    	iPos						= $table.bootstrapTable('getScrollPosition');
			$('.success').removeClass('success');
	    	$element.addClass('success');
	    	return false;
	    })

		$table.on('dbl-click-row.bs.table', function (e, row, $element) {	
			// gestión ventanas
			seleccionarRegistroYcerrar('nExtFormasPago', row.cod, row.des, '');
		})

	    $table.on('sort.bs.table', function (name, order) { 
	    	refresco 	= -1;
	    	return false;
	    })

	    $table.on('search.bs.table', function (text) {
	    	refresco 	= -1;
	    	return false;
	    }) 

	    $table.on('post-body.bs.table', function (data) {
			setTimeout(
		    function () {

		    	// refresco después de inicio, buscar u ordenar
		    	if (refresco == -1) {
						iPos 						= 0;
						window.idTabFormasPago 		= '';
						indiceFila					= seleccionarFila('tabFormasPago', 'idTabFormasPago', 'cod', 'success');
	    			refresco 						= 0;
	    			return false;
		    	}

		    	// refresco después de añadir o eliminar
		    	if (refresco == 1) {
		    		indiceFila	= indice(window.idTabFormasPago, 'cod', 'tabFormasPago');
					iPos 		= Math.abs(tabFormasPago.getElementsByTagName('tr')[indiceFila].offsetTop) - 5;
		    	}

		    	// refresco regular
		    	$table.bootstrapTable('scrollTo', iPos);
		    	refresco = 0;
		    	return false;

			}, 500);
		})

	})

	window.icons = {
		detailOpen: 	'bi-caret-down-fill',
		detailClose: 	'bi-caret-up-fill'
	};

	function rowStyle(row, index) {
	  let customClass = "";
	  if (row.cod == window.idTabFormasPago) { customClass = 'success'; }
	  else {}
	  return { classes: customClass };
	}

	function detailFormatter(index, row) {
		let html = [];
		$.each(row, function (key, value) {
			if  (!(!value || value == '')) {
				let a = '';
				let b = '';
				if (key == 'cod')	{ a = 'Código'; b = value; }
				if (key == 'des') { a = 'Descripción';	b = value; }
				if (key == 'tip') { a = 'Importe';	if (value == '1') { b = 'Fijo'; } else { b = 'Porcentual'; } }
				if (key == 'ctc') { a = 'Cta. tesorería compras';	b = value; }
				if (key == 'ctv') { a = 'Cta. tesorería ventas';	b = value; }
				if (key == 'pav') { a = 'Cobrado/pagado al vencimiento';	b = boolFormato(value, true); }
				if (key == 'pac') { a = 'Por defecto a cuenta'; b = boolFormato(value, true); }
				if (key == 'pcl') { a = 'Por defecto clientes';	b = boolFormato(value, true); }
				if (key == 'ppr') { a = 'Por defecto proveedores';b = boolFormato(value, true); }
				if (key == 'tic') { a = 'Tickets'; b = boolFormato(value, true); }
				if (key == 'tvi') { a = 'Tienda virtual';	b = boolFormato(value, true); }
				if (!(!b || b == '')) {
					html.push('<div><b>' + a + ':</b> ' + b + '</div><p></p>');		
				}
			}
		})
		return html.join('');
	}

  function refrescar(n) {
    refresco = n;
    $table.bootstrapTable('refresh');
    return false;
  }

	function boolFormato(value, row) {
		return formatoBool(value, true);
	}  

	function tipoImporteFormato(value, row) {
		if (value == '1') { return 'Fijo'; } else { return 'Porcentual'; }
	}


</script>


  </body>
</html>